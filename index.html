<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ì°¨ëŸ‰ Â· ì¹´ë“œ Â· ì™¸ê·¼ ê´€ë¦¬ëŒ€ì¥</title>
<link rel="preload" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"></noscript>
<style>
:root {
  --primary:#6366f1;--primary-light:#818cf8;--accent:#a78bfa;--purple:#c084fc;
  --bg-dark:#0f0f1a;--bg-mid:#1a1a2e;
  --text:#e8e8f0;--text-dim:#8888a8;--text-dimmer:#5a5a7a;
  --green:#81c995;--green-bg:rgba(52,168,83,0.15);--red:#ef4444;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{
  font-family:'Pretendard','Apple SD Gothic Neo','Noto Sans KR',sans-serif;
  background:linear-gradient(135deg,var(--bg-dark) 0%,var(--bg-mid) 50%,#16213e 100%);
  color:var(--text);min-height:100vh;min-height:100dvh;
  max-width:480px;margin:0 auto;position:relative;padding-bottom:80px;overflow-x:hidden;
}
::-webkit-scrollbar{width:0}

.header{
  background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(168,85,247,0.1));
  backdrop-filter:blur(20px);padding:20px 20px 16px;
  border-bottom:1px solid rgba(255,255,255,0.06);position:sticky;top:0;z-index:100;
}
.header h1{
  font-size:19px;font-weight:800;
  background:linear-gradient(135deg,#818cf8,#a78bfa,#c084fc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px;
}
.header-sub{font-size:11px;color:#7c7c9a;margin-top:2px;letter-spacing:0.5px}

.month-sel{display:flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(255,255,255,0.02)}
.month-sel span{font-size:13px;color:var(--text-dim);font-weight:600}
.month-sel input{
  background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);
  border-radius:10px;color:#c4b5fd;padding:8px 14px;
  font-size:14px;font-weight:600;outline:none;flex:1;font-family:inherit;
}

.content{padding:8px 16px 16px}

.record-card{
  background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));
  border-radius:16px;padding:16px;margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.06);position:relative;
}
.record-date{font-size:12px;color:var(--primary-light);font-weight:700;letter-spacing:0.5px}
.record-main{font-size:15px;font-weight:600;color:var(--text);margin-top:6px}
.record-sub{font-size:13px;color:var(--text-dim);margin-top:4px}
.badge{display:inline-block;background:rgba(99,102,241,0.15);color:#a5b4fc;border-radius:8px;padding:3px 10px;font-size:12px;font-weight:700;margin-top:8px}
.amount-text{color:var(--purple);margin-left:8px}
.loc-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(52,168,83,0.12);color:var(--green);
  border-radius:8px;padding:3px 10px;font-size:11px;font-weight:600;
  margin-top:6px;cursor:pointer;border:none;font-family:inherit;
}
.loc-badge-orange{
  background:rgba(255,165,0,0.12);color:#ffb347;border:none;cursor:pointer;
  display:inline-flex;align-items:center;gap:4px;
  border-radius:8px;padding:3px 10px;font-size:11px;font-weight:600;margin-top:6px;font-family:inherit;
}
/* íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ */
.timestamp{
  font-size:10px;color:#6a6a8a;margin-top:6px;
  display:flex;align-items:center;gap:4px;
}
.timestamp .edited{color:#ffb347}
.hash-tag{
  font-size:9px;color:#4a4a6a;font-family:monospace;margin-top:2px;
  word-break:break-all;
}

.record-actions{position:absolute;top:14px;right:14px;display:flex;gap:6px}
.act-btn{
  background:rgba(255,255,255,0.06);border:none;border-radius:8px;
  color:var(--text-dim);padding:6px 10px;font-size:12px;cursor:pointer;
}

.fab{
  position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
  width:56px;height:56px;border-radius:50%;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  border:none;color:#fff;font-size:28px;font-weight:300;cursor:pointer;
  box-shadow:0 8px 32px rgba(99,102,241,0.4);
  display:flex;align-items:center;justify-content:center;z-index:90;
}

.bottom-nav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:480px;background:rgba(15,15,26,0.95);backdrop-filter:blur(20px);
  border-top:1px solid rgba(255,255,255,0.06);
  display:flex;justify-content:space-around;
  padding:8px 0 env(safe-area-inset-bottom,12px);z-index:100;
}
.nav-item{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:8px 8px;border-radius:12px;background:transparent;
  border:none;color:var(--text-dimmer);cursor:pointer;font-size:9px;font-weight:500;font-family:inherit;
  flex:1;min-width:0;
}
.nav-item.active{background:rgba(99,102,241,0.12);color:var(--primary-light);font-weight:700}
.nav-icon{font-size:18px}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);
  z-index:200;display:flex;align-items:flex-end;justify-content:center;
}
.sheet{
  background:linear-gradient(180deg,#1e1e36,#16162a);
  border-radius:24px 24px 0 0;width:100%;max-width:480px;
  max-height:90vh;overflow-y:auto;padding:24px 20px 40px;animation:slideUp .3s ease;
}
.form-title{font-size:18px;font-weight:800;color:var(--text);margin-bottom:16px}
.ig{margin-bottom:12px}
.lb{font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:6px;display:block;letter-spacing:.5px}
.inp,.sel{
  width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;color:var(--text);padding:12px 14px;font-size:15px;outline:none;font-family:inherit;
}
.inp:focus,.sel:focus{border-color:rgba(99,102,241,0.5)}
.sel{-webkit-appearance:none}
optgroup{color:var(--text-dim);font-weight:700;font-size:13px}
option{color:var(--text);background:#1e1e36;font-weight:500}
.submit-btn{
  width:100%;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;border-radius:14px;
  color:#fff;padding:14px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;font-family:inherit;
}
.cancel-btn{
  width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;color:var(--text-dim);padding:14px;font-size:16px;font-weight:600;
  cursor:pointer;margin-top:8px;font-family:inherit;
}
.gps-btn{
  width:100%;background:linear-gradient(135deg,rgba(52,168,83,0.25),rgba(34,139,34,0.18));
  border:1px solid rgba(52,168,83,0.4);border-radius:14px;color:var(--green);
  padding:16px;font-size:15px;font-weight:700;cursor:pointer;
  margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:8px;font-family:inherit;
}
.gps-btn.loading{background:rgba(52,168,83,0.08);border-color:rgba(52,168,83,0.15);color:#5a9a6a;pointer-events:none}
.gps-result{
  background:rgba(52,168,83,0.08);border:1px solid rgba(52,168,83,0.2);
  border-radius:12px;padding:14px;margin-bottom:14px;
}
.mini-map{width:100%;height:150px;border-radius:12px;overflow:hidden;margin-top:8px;border:1px solid rgba(255,255,255,0.08)}
.mini-map iframe{width:100%;height:100%;border:0}
.gps-hint{font-size:12px;color:#7c7c9a;text-align:center;margin-bottom:14px;padding:8px;background:rgba(255,255,255,0.02);border-radius:10px}
.divider{border:none;border-top:1px solid rgba(255,255,255,0.06);margin:14px 0}

.empty{text-align:center;padding:60px 20px;color:var(--text-dimmer)}
.sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.sum-card{
  background:linear-gradient(135deg,rgba(99,102,241,0.12),rgba(168,85,247,0.08));
  border-radius:20px;padding:20px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.15);
}
.sum-val{font-size:28px;font-weight:800;background:linear-gradient(135deg,#818cf8,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sum-lbl{font-size:13px;color:var(--text-dim);margin-top:2px}
.cat-bar{background:rgba(255,255,255,0.04);border-radius:8px;height:8px;margin-top:6px;overflow:hidden}
.cat-fill{height:100%;background:linear-gradient(90deg,#6366f1,#a78bfa);border-radius:8px;transition:width .5s ease}

.toast{
  position:fixed;top:24px;left:50%;transform:translateX(-50%);
  background:rgba(99,102,241,0.95);color:#fff;padding:10px 24px;
  border-radius:12px;font-size:14px;font-weight:600;z-index:999;
  animation:fadeIn .2s ease;max-width:360px;text-align:center;pointer-events:none;
}
.del-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:300}
.del-box{background:#1e1e36;border-radius:20px;padding:28px 24px;width:300px;text-align:center}
.map-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:300;padding:20px}
.map-box{background:#1e1e36;border-radius:20px;padding:20px;width:100%;max-width:400px;text-align:center}
/* ì´ë ¥ ëª¨ë‹¬ */
.history-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:300;padding:20px}
.history-box{background:#1e1e36;border-radius:20px;padding:20px;width:100%;max-width:420px;max-height:70vh;overflow-y:auto}
.history-item{background:rgba(255,255,255,0.03);border-radius:10px;padding:10px 12px;margin-bottom:8px;font-size:12px;color:var(--text-dim)}
.history-item .action{color:var(--primary-light);font-weight:700}
.history-item .time{color:#6a6a8a;font-size:10px}

.export-btn{
  width:100%;background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(168,85,247,0.1));
  border:1px solid rgba(99,102,241,0.2);border-radius:16px;color:#a5b4fc;
  padding:14px;font-size:14px;font-weight:700;cursor:pointer;
  margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px;font-family:inherit;
}
.audit-info{
  background:rgba(255,165,0,0.06);border:1px solid rgba(255,165,0,0.15);
  border-radius:12px;padding:14px;margin-top:16px;font-size:12px;color:#d4a054;line-height:1.6;
}
.audit-info b{color:#ffb347}

/* ì¹´ë“œ ê´€ë¦¬ */
.card-mgmt-btn{
  position:fixed;top:16px;right:16px;z-index:101;
  background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);
  border-radius:12px;color:#a5b4fc;padding:8px 14px;font-size:12px;font-weight:700;
  cursor:pointer;font-family:inherit;backdrop-filter:blur(10px);
}
.card-chip{
  display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(135deg,rgba(99,102,241,0.12),rgba(168,85,247,0.08));
  border:1px solid rgba(99,102,241,0.15);border-radius:14px;padding:14px 16px;margin-bottom:8px;
}
.card-chip-info{display:flex;align-items:center;gap:10px}
.card-chip-number{
  font-size:16px;font-weight:800;color:var(--text);letter-spacing:2px;
  font-family:'Courier New',monospace;
}
.card-chip-label{font-size:12px;color:var(--text-dim);margin-top:2px}
.card-chip-icon{font-size:24px}
.card-del-btn{
  background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);
  border-radius:10px;color:#f87171;padding:6px 12px;font-size:12px;font-weight:600;
  cursor:pointer;font-family:inherit;
}
.card-add-row{display:flex;gap:8px;margin-top:12px}
.card-add-row .inp{flex:1}
.card-add-btn{
  background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;border-radius:12px;
  color:#fff;padding:12px 18px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;
  white-space:nowrap;
}
.card-select-row{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;
}
.card-select-chip{
  background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.08);
  border-radius:12px;color:var(--text-dim);padding:10px 14px;font-size:13px;font-weight:600;
  cursor:pointer;font-family:inherit;transition:all .2s;
}
.card-select-chip.selected{
  background:rgba(99,102,241,0.15);border-color:rgba(99,102,241,0.5);color:#a5b4fc;
}
.card-select-chip:active{transform:scale(0.95)}

/* ì™¸ê·¼ ìœ„ì¹˜ì¹´ë“œ */
.loc-card{
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;padding:14px;margin-bottom:10px;position:relative;
}
.loc-card.has-gps{border-color:rgba(52,168,83,0.3);background:rgba(52,168,83,0.05)}
.loc-card-label{font-size:11px;font-weight:700;letter-spacing:0.5px;margin-bottom:8px}
.loc-card-label.start{color:var(--green)}
.loc-card-label.end{color:#a5b4fc}
.loc-card-row{display:flex;gap:8px;align-items:center}
.loc-card-row .inp{flex:1}
.loc-card-gps{
  background:linear-gradient(135deg,rgba(52,168,83,0.25),rgba(34,139,34,0.18));
  border:1px solid rgba(52,168,83,0.4);border-radius:12px;color:var(--green);
  padding:10px 14px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;
  white-space:nowrap;display:flex;align-items:center;gap:4px;
}
.loc-card-gps.end-style{
  background:linear-gradient(135deg,rgba(99,102,241,0.25),rgba(139,92,246,0.18));
  border-color:rgba(99,102,241,0.4);color:#a5b4fc;
}
.loc-card-gps.loading{opacity:0.5;pointer-events:none}
.loc-card-gps.done{background:rgba(52,168,83,0.1);border-color:rgba(52,168,83,0.2);color:#6aab7b}
.loc-card-info{margin-top:8px;font-size:11px;color:var(--text-dim)}
.loc-card-coords{font-size:10px;color:#6a6a8a;margin-top:4px}
.loc-card .mini-map{margin-top:8px}
.pending-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(255,165,0,0.12);color:#ffb347;
  border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;
}
.arrive-btn{
  background:linear-gradient(135deg,rgba(99,102,241,0.25),rgba(139,92,246,0.18));
  border:1px solid rgba(99,102,241,0.4);border-radius:10px;color:#a5b4fc;
  padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;
}
/* ì¦ê²¨ì°¾ê¸° ê´€ë¦¬ */
.place-chip{
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:12px 14px;margin-bottom:6px;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
}
.place-chip-info{flex:1;min-width:0}
.place-chip-name{font-size:14px;font-weight:700;color:var(--text)}
.place-chip-addr{font-size:11px;color:var(--text-dim);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.place-chip-actions{display:flex;gap:4px;flex-shrink:0}
.place-chip-actions button{
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);
  border-radius:8px;color:var(--text-dim);padding:4px 8px;font-size:11px;cursor:pointer;font-family:inherit;
}
.place-picker-list{max-height:240px;overflow-y:auto;margin-bottom:10px}
.place-picker-item{
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:12px 14px;margin-bottom:6px;cursor:pointer;
  transition:all .15s;
}
.place-picker-item:active{transform:scale(0.98);background:rgba(99,102,241,0.12)}
.place-picker-item .pp-name{font-size:14px;font-weight:700;color:var(--text)}
.place-picker-item .pp-addr{font-size:11px;color:var(--text-dim);margin-top:2px}
.loc-card-place{
  background:rgba(255,165,0,0.12);border:1px solid rgba(255,165,0,0.3);
  border-radius:12px;color:#ffb347;padding:10px 14px;font-size:13px;font-weight:700;
  cursor:pointer;font-family:inherit;white-space:nowrap;display:flex;align-items:center;gap:4px;
}

@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.7)}
.hidden{display:none!important}
</style>
</head>
<body>

<div id="toast" class="toast hidden"></div>
<button class="card-mgmt-btn hidden" id="cardMgmtBtn" onclick="openCardMgmt()">ğŸ’³ ì¹´ë“œê´€ë¦¬</button>
<div class="header">
  <h1>ì°¨ëŸ‰ Â· ì¹´ë“œ Â· ì™¸ê·¼ ê´€ë¦¬ëŒ€ì¥</h1>
  <div class="header-sub">ì°¨ëŸ‰ìš´í–‰ Â· ì¹´ë“œì‚¬ìš© Â· ì™¸ê·¼ ê¸°ë¡ê´€ë¦¬ (ì„¸ë¬´ì¦ë¹™ìš©)</div>
</div>
<div class="month-sel"><span>ì¡°íšŒì›”</span><input type="month" id="filterMonth"></div>
<div class="content" id="contentArea"></div>
<button class="fab" id="fabBtn" onclick="openForm()">+</button>

<div class="bottom-nav">
  <button class="nav-item active" data-tab="commute" onclick="switchTab('commute')"><span class="nav-icon">ğŸ </span><span>ì¶œí‡´ê·¼</span></button>
  <button class="nav-item" data-tab="outside" onclick="switchTab('outside')"><span class="nav-icon">ğŸš—</span><span>ì™¸ê·¼</span></button>
  <button class="nav-item" data-tab="card" onclick="switchTab('card')"><span class="nav-icon">ğŸ’³</span><span>ì¹´ë“œ</span></button>
  <button class="nav-item" data-tab="places" onclick="switchTab('places')"><span class="nav-icon">ğŸ¢</span><span>ì¦ê²¨ì°¾ê¸°</span></button>
  <button class="nav-item" data-tab="report" onclick="switchTab('report')"><span class="nav-icon">ğŸ“§</span><span>ë³´ê³ ì²˜</span></button>
  <button class="nav-item" data-tab="summary" onclick="switchTab('summary')"><span class="nav-icon">ğŸ“Š</span><span>ìš”ì•½</span></button>
</div>

<div id="formOverlay" class="overlay hidden" onclick="if(event.target===this)cancelForm()"><div class="sheet" id="formSheet"></div></div>
<div id="delModal" class="del-modal hidden">
  <div class="del-box">
    <div style="font-size:36px;margin-bottom:12px">ğŸ—‘</div>
    <div style="font-size:16px;font-weight:700;margin-bottom:6px">ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div style="font-size:13px;color:#8888a8;margin-bottom:6px">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
    <div style="font-size:11px;color:#d4a054;margin-bottom:16px">âš ï¸ ì‚­ì œ ì´ë ¥ì€ ê°ì‚¬ë¡œê·¸ì— ê¸°ë¡ë©ë‹ˆë‹¤</div>
    <div style="display:flex;gap:10px">
      <button class="cancel-btn" style="flex:1;margin-top:0" onclick="closeDelete()">ì·¨ì†Œ</button>
      <button class="submit-btn" style="flex:1;margin-top:0;background:linear-gradient(135deg,#ef4444,#dc2626)" onclick="confirmDeleteAction()">ì‚­ì œ</button>
    </div>
  </div>
</div>
<div id="mapModal" class="map-modal hidden" onclick="if(event.target===this)closeMap()"><div class="map-box" id="mapBox"></div></div>
<div id="historyModal" class="history-modal hidden" onclick="if(event.target===this)closeHistory()"><div class="history-box" id="historyBox"></div></div>
<div id="cardMgmtModal" class="history-modal hidden" onclick="if(event.target===this)closeCardMgmt()"><div class="history-box" id="cardMgmtBox"></div></div>
<div id="placePickerModal" class="history-modal hidden" onclick="if(event.target===this)closePlacePicker()"><div class="history-box" id="placePickerBox"></div></div>

<script>
// ===== STATE =====
let activeTab='commute';
let commuteRecords=[],outsideRecords=[],cardRecords=[];
let auditLog=[]; // ê°ì‚¬ ë¡œê·¸
let registeredCards=[]; // ë“±ë¡ëœ ë²•ì¸ì¹´ë“œ ëª©ë¡ [{id, last4, label}]
let registeredPlaces=[]; // ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸° ëª©ë¡ [{id, name, address}]
let reportEmails=[]; // ë³´ê³ ì²˜ ë©”ì¼ ëª©ë¡ [{id, email, name, active}]
let editingId=null,deleteTargetId=null,gpsLoading=false;
const CATS_ì ‘ëŒ€=['ì ‘ëŒ€ì‹ë¹„','ì ‘ëŒ€ì„ ë¬¼','ì ‘ëŒ€ìœ í¥','ì ‘ëŒ€ê¸°íƒ€'];
const CATS_ë¹„ì ‘ëŒ€=['ì—…ë¬´ì‹ë¹„','êµí†µë¹„','ìˆ™ë°•ë¹„','ì†Œëª¨í’ˆ','ë³µë¦¬í›„ìƒ','ê¸°íƒ€'];
const CATS=[...CATS_ì ‘ëŒ€,...CATS_ë¹„ì ‘ëŒ€];
function isì ‘ëŒ€(cat){return CATS_ì ‘ëŒ€.includes(cat)}

// ===== HELPERS =====
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function fmtNum(n){return n?Number(n).toLocaleString():''}
function getToday(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function getCurMonth(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function getRecs(t){return t==='commute'?commuteRecords:t==='outside'?outsideRecords:cardRecords}
function getNow(){return new Date().toISOString()}
function getLocalTime(iso){
  if(!iso) return '';
  const d=new Date(iso);
  return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}

// ===== í•´ì‹œ (ë¬´ê²°ì„± ê²€ì¦ìš©) =====
// ê°„ì´ í•´ì‹œ - ê¸°ë¡ ë‚´ìš© ê¸°ë°˜ fingerprint ìƒì„±
function simpleHash(str){
  let h=0;
  for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}
  return Math.abs(h).toString(16).padStart(8,'0');
}
function recordHash(r){
  const raw=JSON.stringify({d:r.date,e:r.endPlace,s:r.startPlace,v:r.visitPlace,p:r.purpose,
    dist:r.distance,st:r.store,amt:r.amount,cat:r.category,lat:r.lat,lng:r.lng,
    ct:r.createdAt,m:r.memo});
  return simpleHash(raw);
}

// ===== ê°ì‚¬ ë¡œê·¸ =====
function addAudit(action, type, recordId, detail){
  auditLog.push({
    timestamp: getNow(),
    action, // CREATE, UPDATE, DELETE, GPS_CHECKIN
    type, // commute, outside, card
    recordId,
    detail: detail||'',
    deviceInfo: navigator.userAgent?.substr(0,80)||''
  });
  saveAll();
}

// ===== STORAGE =====
function loadAll(){
  try{commuteRecords=JSON.parse(localStorage.getItem('wl_commute')||'[]')}catch{commuteRecords=[]}
  try{outsideRecords=JSON.parse(localStorage.getItem('wl_outside')||'[]')}catch{outsideRecords=[]}
  try{cardRecords=JSON.parse(localStorage.getItem('wl_card')||'[]')}catch{cardRecords=[]}
  try{auditLog=JSON.parse(localStorage.getItem('wl_audit')||'[]')}catch{auditLog=[]}
  try{registeredCards=JSON.parse(localStorage.getItem('wl_cards_list')||'[]')}catch{registeredCards=[]}
  try{registeredPlaces=JSON.parse(localStorage.getItem('wl_places')||'[]')}catch{registeredPlaces=[]}
  try{reportEmails=JSON.parse(localStorage.getItem('wl_report_emails')||'[]')}catch{reportEmails=[]}
}
function saveAll(){
  localStorage.setItem('wl_commute',JSON.stringify(commuteRecords));
  localStorage.setItem('wl_outside',JSON.stringify(outsideRecords));
  localStorage.setItem('wl_card',JSON.stringify(cardRecords));
  localStorage.setItem('wl_audit',JSON.stringify(auditLog));
  localStorage.setItem('wl_cards_list',JSON.stringify(registeredCards));
  localStorage.setItem('wl_places',JSON.stringify(registeredPlaces));
  localStorage.setItem('wl_report_emails',JSON.stringify(reportEmails));
}

// ===== TOAST =====
let toastT;
function showToast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.remove('hidden');clearTimeout(toastT);toastT=setTimeout(()=>e.classList.add('hidden'),2500)}

// ===== TABS =====
function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
  document.getElementById('fabBtn').classList.toggle('hidden',t==='summary'||t==='places'||t==='report');
  render();
}

// ===== GPS =====
function getGPS(){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation){rej(new Error('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤'));return}
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy}),
      e=>{if(e.code===1)rej(new Error('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”'));
        else if(e.code===2)rej(new Error('ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
        else rej(new Error('ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ ì´ˆê³¼'))},
      {enableHighAccuracy:true,timeout:15000,maximumAge:0}
    );
  });
}
async function reverseGeo(lat,lng){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko`);
    const d=await r.json();
    if(d?.address){
      const a=d.address;
      const p=[a.province||a.state||'',a.city||a.county||'',a.town||a.suburb||a.district||a.borough||'',a.neighbourhood||a.quarter||'',a.road||''].filter(Boolean);
      return{short:p.slice(-3).join(' ')||'ì£¼ì†Œ ë¶ˆëª…',full:d.display_name||'ì£¼ì†Œ ë¶ˆëª…'};
    }
    return{short:'ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨',full:''};
  }catch{return{short:'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜',full:''};}
}

// ì£¼ì†Œ â†’ ì¢Œí‘œ ê²€ìƒ‰ (Nominatim - ì™¸ë¶€ ì˜ì¡´ ì—†ìŒ)
async function searchGeocode(query){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=ko&countrycodes=kr`);
    const d=await r.json();
    if(d&&d.length>0){
      return d.map(item=>({lat:parseFloat(item.lat),lng:parseFloat(item.lon),display:item.display_name,road:''}));
    }
    return[];
  }catch{return[];}
}

// ì¢Œí‘œ ë˜ëŠ” êµ¬ê¸€ë§µ URL ë¶™ì—¬ë„£ê¸° íŒŒì‹±
function parseCoordPaste(val){
  if(!val)return;
  val=val.trim();

  // êµ¬ê¸€ë§µ ê¸´ URLì—ì„œ ì¢Œí‘œ ì¶”ì¶œ
  let urlMatch=val.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if(!urlMatch)urlMatch=val.match(/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if(!urlMatch)urlMatch=val.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if(!urlMatch)urlMatch=val.match(/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/);
  if(!urlMatch)urlMatch=val.match(/3d(-?\d+\.?\d+).*?4d(-?\d+\.?\d+)/);

  if(urlMatch){
    const a=parseFloat(urlMatch[1]),b=parseFloat(urlMatch[2]);
    if(a>30&&a<40&&b>120&&b<135){
      document.getElementById('placeInlineLat').value=a;
      document.getElementById('placeInlineLng').value=b;
      showToast(`ğŸ“ ì¢Œí‘œ ì¶”ì¶œ ì™„ë£Œ: ${a.toFixed(4)}, ${b.toFixed(4)}`);
      return;
    }
    if(b>30&&b<40&&a>120&&a<135){
      document.getElementById('placeInlineLat').value=b;
      document.getElementById('placeInlineLng').value=a;
      showToast(`ğŸ“ ì¢Œí‘œ ì¶”ì¶œ ì™„ë£Œ: ${b.toFixed(4)}, ${a.toFixed(4)}`);
      return;
    }
  }

  // ì¼ë°˜ ì¢Œí‘œ (ì‰¼í‘œ/ê³µë°±/íƒ­ êµ¬ë¶„)
  const parts=val.replace(/[,\t]/g,' ').split(/\s+/).filter(Boolean);
  if(parts.length>=2){
    const a=parseFloat(parts[0]),b=parseFloat(parts[1]);
    if(!isNaN(a)&&!isNaN(b)){
      if(a>30&&a<40&&b>120&&b<135){
        document.getElementById('placeInlineLat').value=a;
        document.getElementById('placeInlineLng').value=b;
        showToast(`ğŸ“ ì¢Œí‘œ ì…ë ¥ë¨: ${a.toFixed(4)}, ${b.toFixed(4)}`);
      }else if(b>30&&b<40&&a>120&&a<135){
        document.getElementById('placeInlineLat').value=b;
        document.getElementById('placeInlineLng').value=a;
        showToast(`ğŸ“ ì¢Œí‘œ ì…ë ¥ë¨ (ìˆœì„œ ìë™ë³´ì •): ${b.toFixed(4)}, ${a.toFixed(4)}`);
      }
    }
  }
}

// ===== OSRM ë„ë¡œ ê±°ë¦¬ ê³„ì‚° =====
async function calcRouteDistance(lat1,lng1,lat2,lng2){
  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=false`;
    const r=await fetch(url);
    const d=await r.json();
    if(d.code==='Ok'&&d.routes&&d.routes.length>0){
      const distKm=(d.routes[0].distance/1000).toFixed(1);
      const durMin=Math.round(d.routes[0].duration/60);
      return{distance:distKm,duration:durMin};
    }
    return null;
  }catch{return null;}
}

// ì™¸ê·¼ í¼ - ì¶œë°œì§€/ë„ì°©ì§€ ê°œë³„ GPS
async function handleOutsideGPS(point){
  if(gpsLoading)return;gpsLoading=true;
  const btn=document.getElementById(`gpsBtn_${point}`);
  if(btn){btn.textContent='â³';btn.classList.add('loading')}
  try{
    const pos=await getGPS();
    const addr=await reverseGeo(pos.lat,pos.lng);
    document.getElementById(`f_${point}Lat`).value=pos.lat;
    document.getElementById(`f_${point}Lng`).value=pos.lng;
    document.getElementById(`f_${point}Addr`).value=addr.full;
    document.getElementById(`f_${point}Accuracy`).value=pos.accuracy||'';
    document.getElementById(`f_${point}GpsTime`).value=getNow();
    
    const placeInput=document.getElementById(point==='start'?'f_startPlace':'f_endPlace');
    if(placeInput&&!placeInput.value.trim())placeInput.value=addr.short;

    showLocCardMap(point,pos.lat,pos.lng,addr.full);
    // ì¹´ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const card=document.getElementById(point==='start'?'startLocCard':'endLocCard');
    if(card)card.classList.add('has-gps');
    if(btn){btn.textContent='ğŸ“ âœ“';btn.classList.add('done')}
    showToast(`ğŸ“ ${point==='start'?'ì¶œë°œì§€':'ë„ì°©ì§€'}: ${addr.short}`);
    await tryCalcOutsideDistance();
  }catch(e){showToast('âŒ '+e.message)}
  gpsLoading=false;
  if(btn&&!btn.classList.contains('done')){btn.textContent='ğŸ“';btn.classList.remove('loading')}
}

function showLocCardMap(point,lat,lng,addrFull,note){
  const el=document.getElementById(`gpsResult_${point}`);
  if(!el)return;
  lat=Number(lat);lng=Number(lng);
  el.innerHTML=`
    ${note?`<div style="font-size:10px;color:#a5b4fc;font-weight:600;margin-bottom:4px">${note}</div>`:''}
    <div class="loc-card-info">${addrFull||''}</div>
    <div class="loc-card-coords">ì¢Œí‘œ: ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
    <div class="mini-map"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.005},${lat-0.003},${lng+0.005},${lat+0.003}&layer=mapnik&marker=${lat},${lng}"></iframe></div>
  `;
}

// ì¶œë°œë§Œ ê¸°ë¡ (ì™¸ê·¼)
function submitOutsideStartOnly(){
  const g=id=>document.getElementById('f_'+id)?.value?.trim()||'';
  const now=getNow();
  const date=g('date')||getToday();
  const rec={
    startLat:parseFloat(g('startLat'))||null,startLng:parseFloat(g('startLng'))||null,
    startAddr:g('startAddr'),startAccuracy:parseFloat(g('startAccuracy'))||null,startGpsTime:g('startGpsTime')||null,
    lat:null,lng:null,address:'',gpsAccuracy:null,gpsTime:null,
    date,visitPlace:g('visitPlace'),purpose:g('purpose'),
    startPlace:g('startPlace'),endPlace:'',distance:'',memo:g('memo'),
    pendingArrival:true,
    createdAt:now,lastModified:now,editCount:0
  };
  const id=genId();outsideRecords.unshift({...rec,id});
  addAudit('CREATE','outside',id,`ì¶œë°œê¸°ë¡: ${date} / ${rec.startPlace||'ì¶œë°œ'}`);
  saveAll();cancelForm();showToast('ğŸš— ì¶œë°œ ê¸°ë¡ë¨ - ë„ì°© ì‹œ ì´ì–´ì„œ ë“±ë¡í•˜ì„¸ìš”');render();
}

// ì¶œë°œë§Œ ê¸°ë¡ (ì¶œí‡´ê·¼)
function submitCommuteStartOnly(){
  const g=id=>document.getElementById('f_'+id)?.value?.trim()||'';
  const now=getNow();
  const date=g('date')||getToday();
  const rec={
    startLat:parseFloat(g('startLat'))||null,startLng:parseFloat(g('startLng'))||null,
    startAddr:g('startAddr'),startAccuracy:parseFloat(g('startAccuracy'))||null,startGpsTime:g('startGpsTime')||null,
    lat:null,lng:null,address:'',gpsAccuracy:null,gpsTime:null,
    date,startPlace:g('startPlace'),endPlace:'',distance:'',memo:g('memo'),
    pendingArrival:true,
    createdAt:now,lastModified:now,editCount:0
  };
  const id=genId();commuteRecords.unshift({...rec,id});
  addAudit('CREATE','commute',id,`ì¶œë°œê¸°ë¡: ${date} / ${rec.startPlace||'ì¶œë°œ'}`);
  saveAll();cancelForm();showToast('ğŸš— ì¶œë°œ ê¸°ë¡ë¨ - ë„ì°© ì‹œ ì´ì–´ì„œ ë“±ë¡í•˜ì„¸ìš”');render();
}

// ë„ì°© ë“±ë¡ (ê³µí†µ - ì¶œí‡´ê·¼/ì™¸ê·¼)
function openArrivalForm(id){
  // ì–´ëŠ íƒ­ ê¸°ë¡ì¸ì§€ íŒë³„
  let record=outsideRecords.find(r=>r.id===id);
  let arrType='outside';
  if(!record){record=commuteRecords.find(r=>r.id===id);arrType='commute';}
  if(!record)return;
  editingId=id;
  const sheet=document.getElementById('formSheet');
  let h=`<div class="form-title">ğŸ ë„ì°© ë“±ë¡</div>`;
  h+=`<div style="background:rgba(52,168,83,0.08);border:1px solid rgba(52,168,83,0.2);border-radius:14px;padding:12px;margin-bottom:12px">
    <div style="font-size:11px;color:var(--green);font-weight:700">ğŸŸ¢ ì¶œë°œ ì •ë³´</div>
    <div style="font-size:14px;color:var(--text);font-weight:600;margin-top:2px">${record.startPlace||'ì¶œë°œì§€'}</div>
    <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${record.date} ì¶œë°œ${record.startAddr?' Â· '+record.startAddr:''}</div>
  </div>`;

  // hidden - ê¸°ì¡´ ì¶œë°œ ë°ì´í„° ìœ ì§€
  h+=`<input type="hidden" id="f_startLat" value="${record.startLat||''}">`;
  h+=`<input type="hidden" id="f_startLng" value="${record.startLng||''}">`;
  h+=`<input type="hidden" id="f_startAddr" value="${record.startAddr||''}">`;
  h+=`<input type="hidden" id="f_startAccuracy" value="${record.startAccuracy||''}">`;
  h+=`<input type="hidden" id="f_startGpsTime" value="${record.startGpsTime||''}">`;
  h+=`<input type="hidden" id="f_endLat" value="">`;
  h+=`<input type="hidden" id="f_endLng" value="">`;
  h+=`<input type="hidden" id="f_endAddr" value="">`;
  h+=`<input type="hidden" id="f_endAccuracy" value="">`;
  h+=`<input type="hidden" id="f_endGpsTime" value="">`;
  h+=`<input type="hidden" id="f_date" value="${record.date}">`;
  h+=`<input type="hidden" id="f_startPlace" value="${record.startPlace||''}">`;

  // ë„ì°©ì§€ ì¹´ë“œ
  h+=`<div class="loc-card" id="endLocCard">`;
  h+=`<div class="loc-card-label end">ğŸ”µ ë„ì°©ì§€</div>`;
  h+=`<div class="loc-card-row">`;
  h+=`<input class="inp" type="text" id="f_endPlace" placeholder="ë„ì°©ì§€ ì…ë ¥" value="">`;
  h+=`<button class="loc-card-place" onclick="openPlacePicker('arrival_end')">ğŸ¢</button>`;
  h+=`<button class="loc-card-gps end-style" id="gpsBtn_end" onclick="handleOutsideGPS('end')">ğŸ“</button>`;
  h+=`</div>`;
  h+=`<div id="gpsResult_end"></div>`;
  h+=`</div>`;
  h+=`<div id="routeResult" class="gps-result hidden" style="margin-bottom:10px;border-color:rgba(129,201,149,0.3);background:rgba(129,201,149,0.08)"></div>`;
  h+=`<input type="hidden" id="f_arrType" value="${arrType}">`;

  if(arrType==='outside'){
    h+=`<div class="ig"><label class="lb">ë°©ë¬¸ì²˜</label><input class="inp" id="f_visitPlace" value="${record.visitPlace||''}" placeholder="ì˜ˆ: ì¥ì†Œëª…"></div>`;
    h+=`<div class="ig"><label class="lb">ëª©ì </label><input class="inp" id="f_purpose" value="${record.purpose||''}" placeholder="ì˜ˆ: ë¯¸íŒ…, ë‚©í’ˆ"></div>`;
  }
  h+=`<div class="ig"><label class="lb">ì£¼í–‰ê±°ë¦¬ km</label><input class="inp" type="number" id="f_distance" value="" placeholder="GPS ì‹œ ìë™ê³„ì‚°"></div>`;
  h+=`<div class="ig"><label class="lb">ë©”ëª¨</label><input class="inp" id="f_memo" value="${record.memo||''}" placeholder="ì°¸ê³  ì‚¬í•­"></div>`;

  h+=`<button class="submit-btn" onclick="submitArrival('${id}')">ğŸ ë„ì°© ì™„ë£Œ</button>`;
  h+=`<button class="cancel-btn" onclick="cancelForm()">ì·¨ì†Œ</button>`;
  sheet.innerHTML=h;
  document.getElementById('formOverlay').classList.remove('hidden');
}

function submitArrival(id){
  const g=fid=>document.getElementById('f_'+fid)?.value?.trim()||'';
  const now=getNow();
  const endLat=parseFloat(g('endLat'))||null;
  const endLng=parseFloat(g('endLng'))||null;
  const arrType=g('arrType')||'outside';
  const updater=r=>{
    if(r.id!==id)return r;
    const upd={...r,
      lat:endLat,lng:endLng,address:g('endAddr'),gpsAccuracy:parseFloat(g('endAccuracy'))||null,gpsTime:g('endGpsTime')||null,
      endPlace:g('endPlace'),distance:g('distance'),memo:g('memo')||r.memo,
      pendingArrival:false,
      lastModified:now,editCount:(r.editCount||0)+1
    };
    if(arrType==='outside'){upd.visitPlace=g('visitPlace')||r.visitPlace;upd.purpose=g('purpose')||r.purpose;}
    return upd;
  };
  if(arrType==='commute')commuteRecords=commuteRecords.map(updater);
  else outsideRecords=outsideRecords.map(updater);
  addAudit('UPDATE',arrType,id,`ë„ì°©ë“±ë¡: ${g('endPlace')||''}${g('distance')?' / '+g('distance')+'km':''}`);
  saveAll();cancelForm();showToast('ğŸ ë„ì°© ë“±ë¡ ì™„ë£Œ');render();
  // ì™¸ê·¼ ë„ì°© ì‹œ ê³µìœ  í™•ì¸
  if(arrType==='outside'){
    const rec=outsideRecords.find(r=>r.id===id);
    if(rec)setTimeout(()=>{if(confirm('ğŸ’¬ ì™¸ê·¼ ê¸°ë¡ì„ ì¹´í†¡ìœ¼ë¡œ ê³µìœ í• ê¹Œìš”?'))shareOutsideRecord(rec);},300);
  }
}

async function tryCalcOutsideDistance(){
  const sLat=parseFloat(document.getElementById('f_startLat')?.value);
  const sLng=parseFloat(document.getElementById('f_startLng')?.value);
  const eLat=parseFloat(document.getElementById('f_endLat')?.value);
  const eLng=parseFloat(document.getElementById('f_endLng')?.value);
  const distEl=document.getElementById('routeResult');
  const distInput=document.getElementById('f_distance');
  
  if(!sLat||!sLng||!eLat||!eLng){
    if(distEl)distEl.classList.add('hidden');
    return;
  }

  if(distEl){
    distEl.classList.remove('hidden');
    distEl.innerHTML=`<div style="font-size:13px;color:#ffb347;font-weight:600;text-align:center">ğŸ”„ ë„ë¡œ ê±°ë¦¬ ê³„ì‚° ì¤‘...</div>`;
  }

  const result=await calcRouteDistance(sLat,sLng,eLat,eLng);
  if(result){
    if(distInput)distInput.value=result.distance;
    if(distEl){
      distEl.innerHTML=`
        <div style="display:flex;align-items:center;gap:10px;justify-content:center">
          <div style="text-align:center">
            <div style="font-size:11px;color:var(--green);font-weight:700">ğŸ›£ï¸ ë„ë¡œ ê±°ë¦¬</div>
            <div style="font-size:24px;font-weight:800;color:#81c995;margin-top:2px">${result.distance} km</div>
          </div>
          <div style="width:1px;height:36px;background:rgba(255,255,255,0.1)"></div>
          <div style="text-align:center">
            <div style="font-size:11px;color:var(--text-dim);font-weight:700">â±ï¸ ì˜ˆìƒ ì‹œê°„</div>
            <div style="font-size:24px;font-weight:800;color:var(--text-dim);margin-top:2px">${result.duration}ë¶„</div>
          </div>
        </div>
        <div style="font-size:10px;color:#6a6a8a;text-align:center;margin-top:6px">OSRM ë„ë¡œ ê²½ë¡œ ê¸°ì¤€ (ì‹¤ì œ ë„¤ë¹„ ê±°ë¦¬ì™€ ìœ ì‚¬)</div>
      `;
    }
    showToast(`ğŸ›£ï¸ ë„ë¡œ ê±°ë¦¬: ${result.distance}km (ì•½ ${result.duration}ë¶„)`);
  }else{
    if(distEl){
      distEl.innerHTML=`<div style="font-size:12px;color:#f87171;text-align:center">âš ï¸ ë„ë¡œ ê±°ë¦¬ ê³„ì‚° ì‹¤íŒ¨ - ìˆ˜ë™ ì…ë ¥í•´ì£¼ì„¸ìš”</div>`;
    }
  }
}

// ê¸°ì¡´ íƒ­ìš© (ì¶œí‡´ê·¼/ì¹´ë“œ) GPS í•¸ë“¤ëŸ¬
async function handleGPSInForm(){
  if(gpsLoading)return;gpsLoading=true;
  const btn=document.getElementById('gpsBtn');
  if(btn){btn.textContent='â³ ìœ„ì¹˜ í™•ì¸ ì¤‘...';btn.classList.add('loading')}
  try{
    const pos=await getGPS();
    const addr=await reverseGeo(pos.lat,pos.lng);
    const target=activeTab==='card'?document.getElementById('f_store'):document.getElementById('f_endPlace');
    if(target)target.value=addr.short;
    document.getElementById('f_lat').value=pos.lat;
    document.getElementById('f_lng').value=pos.lng;
    document.getElementById('f_address').value=addr.full;
    document.getElementById('f_gpsAccuracy').value=pos.accuracy||'';
    document.getElementById('f_gpsTime').value=getNow();
    const gpsRes=document.getElementById('gpsResult');
    gpsRes.classList.remove('hidden');
    gpsRes.innerHTML=`
      <div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:4px">ğŸ“ ìœ„ì¹˜ í™•ì¸ë¨</div>
      <div style="font-size:14px;color:var(--text);font-weight:600">${addr.short}</div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${addr.full}</div>
      <div style="font-size:10px;color:#6a6a8a;margin-top:4px">ì¢Œí‘œ: ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)} (ì •í™•ë„: ${pos.accuracy?Math.round(pos.accuracy)+'m':'N/A'})</div>
      <div style="font-size:10px;color:#6a6a8a">ì¸¡ì •ì‹œê°: ${getLocalTime(getNow())}</div>
      <div class="mini-map"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${pos.lng-0.005},${pos.lat-0.003},${pos.lng+0.005},${pos.lat+0.003}&layer=mapnik&marker=${pos.lat},${pos.lng}"></iframe></div>
    `;
    showToast('ğŸ“ ìœ„ì¹˜: '+addr.short);
  }catch(e){showToast('âŒ '+e.message)}
  gpsLoading=false;
  if(btn){btn.textContent='ğŸ“ í˜„ì¬ ìœ„ì¹˜ ë“±ë¡';btn.classList.remove('loading')}
}

async function quickCheckin(type,id){
  if(gpsLoading)return;gpsLoading=true;
  showToast('ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  try{
    const pos=await getGPS();
    const addr=await reverseGeo(pos.lat,pos.lng);
    const gpsTime=getNow();
    const upd=r=>r.id===id?{...r,lat:pos.lat,lng:pos.lng,address:addr.full,
      endPlace:type==='card'?r.store:addr.short,
      gpsAccuracy:pos.accuracy,gpsTime,
      lastModified:gpsTime,editCount:(r.editCount||0)+1}:r;
    if(type==='commute')commuteRecords=commuteRecords.map(upd);
    else if(type==='outside')outsideRecords=outsideRecords.map(upd);
    else cardRecords=cardRecords.map(upd);
    addAudit('GPS_CHECKIN',type,id,`ìœ„ì¹˜: ${addr.short} (${pos.lat.toFixed(6)},${pos.lng.toFixed(6)})`);
    saveAll();showToast('ğŸ“ ìœ„ì¹˜ ë“±ë¡: '+addr.short);render();
  }catch(e){showToast('âŒ '+e.message)}
  gpsLoading=false;
}

// ===== MAP =====
function showMap(type,id){
  const r=getRecs(type).find(x=>x.id===id);if(!r)return;

  // ì¶œí‡´ê·¼/ì™¸ê·¼: ì¶œë°œì§€Â·ë„ì°©ì§€ ì–‘ìª½ ì§€ë„
  if((type==='outside'||type==='commute')&&(r.startLat||r.lat)){
    let mh='';
    if(r.startLat&&r.lat){
      mh+=`<div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:12px">ğŸ“ ${type==='outside'?'ì™¸ê·¼':'ì¶œí‡´ê·¼'} ê²½ë¡œ</div>`;
      // ì¶œë°œì§€
      mh+=`<div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:4px">ğŸŸ¢ ì¶œë°œì§€: ${r.startPlace||'ì¶œë°œì§€'}</div>`;
      mh+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">${r.startAddr||''}</div>`;
      mh+=`<div style="font-size:10px;color:#6a6a8a;margin-bottom:4px">ì¢Œí‘œ: ${Number(r.startLat).toFixed(6)}, ${Number(r.startLng).toFixed(6)}${r.startAccuracy?' / ì •í™•ë„: '+Math.round(r.startAccuracy)+'m':''}</div>`;
      mh+=`<div class="mini-map" style="height:180px;margin-bottom:14px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${r.startLng-0.006},${r.startLat-0.004},${Number(r.startLng)+0.006},${Number(r.startLat)+0.004}&layer=mapnik&marker=${r.startLat},${r.startLng}"></iframe></div>`;
      // í™”ì‚´í‘œ
      mh+=`<div style="text-align:center;font-size:20px;color:var(--primary-light);margin:4px 0">â¬‡ï¸</div>`;
      if(r.distance)mh+=`<div style="text-align:center;font-size:14px;font-weight:700;color:var(--green);margin-bottom:8px">ğŸ›£ï¸ ${r.distance} km</div>`;
      // ë„ì°©ì§€
      mh+=`<div style="font-size:12px;color:#a5b4fc;font-weight:700;margin-bottom:4px">ğŸ”µ ë„ì°©ì§€: ${r.endPlace||r.visitPlace||'ë„ì°©ì§€'}</div>`;
      mh+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">${r.address||''}</div>`;
      mh+=`<div style="font-size:10px;color:#6a6a8a;margin-bottom:4px">ì¢Œí‘œ: ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}${r.gpsAccuracy?' / ì •í™•ë„: '+Math.round(r.gpsAccuracy)+'m':''}</div>`;
      mh+=`<div class="mini-map" style="height:180px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${r.lng-0.006},${r.lat-0.004},${Number(r.lng)+0.006},${Number(r.lat)+0.004}&layer=mapnik&marker=${r.lat},${r.lng}"></iframe></div>`;
    }else if(r.lat){
      mh+=`<div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ“ ${r.visitPlace||r.endPlace||'ìœ„ì¹˜'}</div>`;
      mh+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:4px">${r.address||''}</div>`;
      mh+=`<div style="font-size:10px;color:#6a6a8a;margin-bottom:12px">ì¢Œí‘œ: ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}</div>`;
      mh+=`<div class="mini-map" style="height:250px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${r.lng-0.008},${r.lat-0.005},${Number(r.lng)+0.008},${Number(r.lat)+0.005}&layer=mapnik&marker=${r.lat},${r.lng}"></iframe></div>`;
    }else if(r.startLat){
      mh+=`<div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ“ ì¶œë°œì§€: ${r.startPlace||'ì¶œë°œì§€'}</div>`;
      mh+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:4px">${r.startAddr||''}</div>`;
      mh+=`<div style="font-size:10px;color:#6a6a8a;margin-bottom:12px">ì¢Œí‘œ: ${Number(r.startLat).toFixed(6)}, ${Number(r.startLng).toFixed(6)}</div>`;
      mh+=`<div class="mini-map" style="height:250px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${r.startLng-0.008},${r.startLat-0.005},${Number(r.startLng)+0.008},${Number(r.startLat)+0.005}&layer=mapnik&marker=${r.startLat},${r.startLng}"></iframe></div>`;
    }
    mh+=`<button class="cancel-btn" style="margin-top:14px" onclick="closeMap()">ë‹«ê¸°</button>`;
    document.getElementById('mapBox').innerHTML=mh;
    document.getElementById('mapModal').classList.remove('hidden');
    return;
  }

  if(!r.lat)return;
  const name=type==='card'?(r.store||'ì‚¬ìš©ì²˜'):(r.visitPlace||r.endPlace||'ìœ„ì¹˜');
  document.getElementById('mapBox').innerHTML=`
    <div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ“ ${name}</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px">${r.address||''}</div>
    <div style="font-size:10px;color:#6a6a8a;margin-bottom:12px">ì¸¡ì •: ${getLocalTime(r.gpsTime)} / ì •í™•ë„: ${r.gpsAccuracy?Math.round(r.gpsAccuracy)+'m':'N/A'}</div>
    <div class="mini-map" style="height:250px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${r.lng-0.008},${r.lat-0.005},${Number(r.lng)+0.008},${Number(r.lat)+0.005}&layer=mapnik&marker=${r.lat},${r.lng}"></iframe></div>
    <div style="font-size:11px;color:#6a6a8a;margin-top:8px">ì¢Œí‘œ: ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}</div>
    <button class="cancel-btn" style="margin-top:14px" onclick="closeMap()">ë‹«ê¸°</button>
  `;
  document.getElementById('mapModal').classList.remove('hidden');
}
function closeMap(){document.getElementById('mapModal').classList.add('hidden')}

// ===== DELETE =====
function askDelete(id){deleteTargetId=id;document.getElementById('delModal').classList.remove('hidden')}
function closeDelete(){deleteTargetId=null;document.getElementById('delModal').classList.add('hidden')}
function confirmDeleteAction(){
  if(!deleteTargetId)return;
  const rec=getRecs(activeTab).find(r=>r.id===deleteTargetId);
  const detail=rec?`ë‚ ì§œ:${rec.date} / ${rec.endPlace||rec.store||rec.visitPlace||''}`:''
  addAudit('DELETE',activeTab,deleteTargetId,detail);
  if(activeTab==='commute')commuteRecords=commuteRecords.filter(r=>r.id!==deleteTargetId);
  else if(activeTab==='outside')outsideRecords=outsideRecords.filter(r=>r.id!==deleteTargetId);
  else cardRecords=cardRecords.filter(r=>r.id!==deleteTargetId);
  saveAll();closeDelete();showToast('ì‚­ì œ ì™„ë£Œ (ì´ë ¥ ê¸°ë¡ë¨)');render();
}

// ===== HISTORY =====
function showHistory(){
  const box=document.getElementById('historyBox');
  const recent=auditLog.slice(-50).reverse();
  let h=`<div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:16px">ğŸ“‹ ê°ì‚¬ ë¡œê·¸ (ìµœê·¼ 50ê±´)</div>`;
  if(!recent.length) h+=`<div style="color:var(--text-dim);text-align:center;padding:20px">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
  recent.forEach(a=>{
    const actionLabel={'CREATE':'ìƒì„±','UPDATE':'ìˆ˜ì •','DELETE':'ì‚­ì œ','GPS_CHECKIN':'ìœ„ì¹˜ë“±ë¡'}[a.action]||a.action;
    const typeLabel={'commute':'ì¶œí‡´ê·¼','outside':'ì™¸ê·¼','card':'ì¹´ë“œ'}[a.type]||a.type;
    h+=`<div class="history-item">
      <span class="action">[${actionLabel}]</span> ${typeLabel} - ${a.detail||''}
      <div class="time">ğŸ• ${getLocalTime(a.timestamp)}</div>
    </div>`;
  });
  h+=`<button class="cancel-btn" style="margin-top:14px" onclick="closeHistory()">ë‹«ê¸°</button>`;
  box.innerHTML=h;
  document.getElementById('historyModal').classList.remove('hidden');
}
function closeHistory(){document.getElementById('historyModal').classList.add('hidden')}

// ===== CARD MANAGEMENT =====
function updateCardMgmtBtn(){
  const btn=document.getElementById('cardMgmtBtn');
  if(btn) btn.classList.toggle('hidden',registeredCards.length===0);
}
function openCardMgmt(){
  renderCardMgmt();
  document.getElementById('cardMgmtModal').classList.remove('hidden');
}
function closeCardMgmt(){document.getElementById('cardMgmtModal').classList.add('hidden')}
function renderCardMgmt(){
  const box=document.getElementById('cardMgmtBox');
  let h=`<div style="font-size:18px;font-weight:800;color:var(--text);margin-bottom:6px">ğŸ’³ ë²•ì¸ì¹´ë“œ ê´€ë¦¬</div>`;
  h+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:16px">ì¹´ë“œ ë’·ìë¦¬ 4ìë¦¬ë¥¼ ë“±ë¡í•˜ì„¸ìš”. ì¹´ë“œ ì‚¬ìš© ê¸°ë¡ ì‹œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>`;
  
  if(registeredCards.length===0){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-dimmer);font-size:14px">ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
  }else{
    registeredCards.forEach((c,i)=>{
      h+=`<div class="card-chip">
        <div class="card-chip-info">
          <div class="card-chip-icon">ğŸ’³</div>
          <div>
            <div class="card-chip-number">**** ${c.last4}</div>
            ${c.label?`<div class="card-chip-label">${c.label}</div>`:''}
          </div>
        </div>
        <button class="card-del-btn" onclick="deleteCard(${i})">ì‚­ì œ</button>
      </div>`;
    });
  }
  
  h+=`<div style="margin-top:16px;font-size:13px;font-weight:700;color:var(--text-dim);margin-bottom:8px">ì¹´ë“œ ì¶”ê°€</div>`;
  h+=`<div class="card-add-row">
    <input class="inp" id="cardInput4" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="ë’·4ìë¦¬" style="flex:0.6">
    <input class="inp" id="cardInputLabel" type="text" placeholder="ë³„ì¹­ (ì„ íƒ)" style="flex:1">
    <button class="card-add-btn" onclick="addCard()">ì¶”ê°€</button>
  </div>`;
  h+=`<button class="cancel-btn" style="margin-top:16px" onclick="closeCardMgmt()">ë‹«ê¸°</button>`;
  box.innerHTML=h;
}
function addCard(){
  const last4=document.getElementById('cardInput4').value.trim();
  const label=document.getElementById('cardInputLabel').value.trim();
  if(!/^\d{4}$/.test(last4)){showToast('âŒ ì¹´ë“œ ë’·ìë¦¬ 4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  if(registeredCards.some(c=>c.last4===last4)){showToast('âŒ ì´ë¯¸ ë“±ë¡ëœ ì¹´ë“œì…ë‹ˆë‹¤');return}
  registeredCards.push({id:genId(),last4,label});
  saveAll();
  addAudit('CREATE','card_mgmt','',`ì¹´ë“œ ë“±ë¡: **** ${last4} ${label?'('+label+')':''}`);
  showToast(`ğŸ’³ ì¹´ë“œ **** ${last4} ë“±ë¡ ì™„ë£Œ`);
  updateCardMgmtBtn();
  renderCardMgmt();
}
function addCardInline(){
  const last4=document.getElementById('inlineCard4').value.trim();
  const label=document.getElementById('inlineCardLabel').value.trim();
  if(!/^\d{4}$/.test(last4)){showToast('âŒ ì¹´ë“œ ë’·ìë¦¬ 4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  if(registeredCards.some(c=>c.last4===last4)){showToast('âŒ ì´ë¯¸ ë“±ë¡ëœ ì¹´ë“œì…ë‹ˆë‹¤');return}
  registeredCards.push({id:genId(),last4,label});
  saveAll();
  addAudit('CREATE','card_mgmt','',`ì¹´ë“œ ë“±ë¡: **** ${last4} ${label?'('+label+')':''}`);
  showToast(`ğŸ’³ ì¹´ë“œ **** ${last4} ë“±ë¡ ì™„ë£Œ`);
  updateCardMgmtBtn();
  // í¼ ë‚´ ì¹´ë“œ ì„ íƒ ì˜ì—­ ë¦¬í”„ë ˆì‹œ
  refreshCardPicker(last4);
}
function refreshCardPicker(selectLast4){
  const container=document.getElementById('cardPickerContainer');
  if(!container)return;
  let h='';
  if(registeredCards.length===0){
    h+=`<div style="font-size:13px;color:var(--text-dimmer);padding:12px;background:rgba(255,255,255,0.03);border-radius:12px;text-align:center">ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
    h+=`<div class="card-add-row" style="margin-top:8px">
      <input class="inp" id="inlineCard4" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="ë’·4ìë¦¬" style="flex:0.6">
      <input class="inp" id="inlineCardLabel" type="text" placeholder="ë³„ì¹­ (ì„ íƒ)" style="flex:1">
      <button class="card-add-btn" onclick="addCardInline()">ì¶”ê°€</button>
    </div>`;
    h+=`<input type="hidden" id="f_cardSelect" value="">`;
  }else{
    h+=`<div class="card-select-row" id="cardSelectRow">`;
    registeredCards.forEach(c=>{
      const isSel=selectLast4===c.last4;
      h+=`<button type="button" class="card-select-chip ${isSel?'selected':''}" data-card="${c.last4}" onclick="pickCard(this,'${c.last4}')">
        ğŸ’³ **** ${c.last4}${c.label?' Â· '+c.label:''}
      </button>`;
    });
    h+=`</div>`;
    h+=`<div class="card-add-row" style="margin-top:8px">
      <input class="inp" id="inlineCard4" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="ë’·4ìë¦¬ ì¶”ê°€" style="flex:0.6">
      <input class="inp" id="inlineCardLabel" type="text" placeholder="ë³„ì¹­" style="flex:1">
      <button class="card-add-btn" style="padding:10px 14px;font-size:13px" onclick="addCardInline()">+</button>
    </div>`;
    h+=`<input type="hidden" id="f_cardSelect" value="${selectLast4||''}">`;
  }
  container.innerHTML=h;
}
function deleteCard(idx){
  const c=registeredCards[idx];
  if(!c)return;
  if(!confirm(`ì¹´ë“œ **** ${c.last4}${c.label?' ('+c.label+')':''}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  registeredCards.splice(idx,1);
  saveAll();
  addAudit('DELETE','card_mgmt','',`ì¹´ë“œ ì‚­ì œ: **** ${c.last4} ${c.label?'('+c.label+')':''}`);
  showToast(`ì¹´ë“œ **** ${c.last4} ì‚­ì œë¨`);
  updateCardMgmtBtn();
  renderCardMgmt();
}

// ===== PLACE PICKER (ì¶œë°œì§€/ë„ì°©ì§€ ì„ íƒ) =====
let placePickerTarget=null;
let inlineEditPlaceIdx=null; // places íƒ­ ë‚´ ì¸ë¼ì¸ ìˆ˜ì •ìš©
let inlineEditEmailIdx=null; // report íƒ­ ë‚´ ì¸ë¼ì¸ ìˆ˜ì •ìš©

function startEditPlaceInline(idx){inlineEditPlaceIdx=idx;render()}
function cancelInlinePlaceEdit(){inlineEditPlaceIdx=null;render()}
function addPlaceInline(){
  const name=document.getElementById('placeInlineName').value.trim();
  const address=document.getElementById('placeInlineAddr').value.trim();
  const lat=parseFloat(document.getElementById('placeInlineLat')?.value)||null;
  const lng=parseFloat(document.getElementById('placeInlineLng')?.value)||null;
  if(!name){showToast('âŒ ì¦ê²¨ì°¾ê¸°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  const place={id:genId(),name,address};
  if(lat&&lng){place.lat=lat;place.lng=lng;}
  registeredPlaces.push(place);
  saveAll();addAudit('CREATE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° ë“±ë¡: ${name}${lat?' (ì¢Œí‘œí¬í•¨)':''}`);
  showToast(`ğŸ¢ ${name} ë“±ë¡ ì™„ë£Œ${lat?' (ì¢Œí‘œ í¬í•¨)':''}`);render();
}
function saveInlinePlaceEdit(){
  if(inlineEditPlaceIdx===null)return;
  const name=document.getElementById('placeInlineName').value.trim();
  const address=document.getElementById('placeInlineAddr').value.trim();
  const lat=parseFloat(document.getElementById('placeInlineLat')?.value)||null;
  const lng=parseFloat(document.getElementById('placeInlineLng')?.value)||null;
  if(!name){showToast('âŒ ì¦ê²¨ì°¾ê¸°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  const old=registeredPlaces[inlineEditPlaceIdx];
  registeredPlaces[inlineEditPlaceIdx]={...old,name,address};
  if(lat&&lng){registeredPlaces[inlineEditPlaceIdx].lat=lat;registeredPlaces[inlineEditPlaceIdx].lng=lng;}
  saveAll();addAudit('UPDATE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° ìˆ˜ì •: ${name}`);
  showToast(`ğŸ¢ ${name} ìˆ˜ì • ì™„ë£Œ`);inlineEditPlaceIdx=null;render();
}
function deletePlace(idx){
  const p=registeredPlaces[idx];
  if(!p||!confirm(`ì¦ê²¨ì°¾ê¸° "${p.name}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  registeredPlaces.splice(idx,1);saveAll();
  addAudit('DELETE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° ì‚­ì œ: ${p.name}`);
  showToast(`ì¦ê²¨ì°¾ê¸° ì‚­ì œë¨`);if(inlineEditPlaceIdx===idx)inlineEditPlaceIdx=null;render();
}

function movePlaceUp(idx){
  if(idx<=0)return;
  [registeredPlaces[idx-1],registeredPlaces[idx]]=[registeredPlaces[idx],registeredPlaces[idx-1]];
  saveAll();render();
}
function movePlaceDown(idx){
  if(idx>=registeredPlaces.length-1)return;
  [registeredPlaces[idx],registeredPlaces[idx+1]]=[registeredPlaces[idx+1],registeredPlaces[idx]];
  saveAll();render();
}

// ì¦ê²¨ì°¾ê¸° ë‚´ë³´ë‚´ê¸° (txt)
function exportPlaces(){
  if(!registeredPlaces.length){showToast('âŒ ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
  let txt=`# ì¦ê²¨ì°¾ê¸° ëª©ë¡ (${new Date().toISOString().slice(0,10)})\n`;
  txt+=`# ì´ë¦„\tì£¼ì†Œ\tìœ„ë„\tê²½ë„\n`;
  txt+=`#---\n`;
  registeredPlaces.forEach(p=>{
    txt+=`${p.name}\t${p.address||''}\t${p.lat||''}\t${p.lng||''}\n`;
  });
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`ì™¸ê·¼ì°¨ëŸ‰ì¹´ë“œê´€ë¦¬ëŒ€ì¥_ì¦ê²¨ì°¾ê¸°_${new Date().toISOString().slice(0,10)}.txt`;a.click();
  URL.revokeObjectURL(url);
  showToast(`ğŸ“¤ ${registeredPlaces.length}ê°œ ì¦ê²¨ì°¾ê¸° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ`);
}

// ì¦ê²¨ì°¾ê¸° txt â†’ ë°°ì—´ íŒŒì‹± ê³µí†µí•¨ìˆ˜
function parsePlacesTxt(text){
  const imported=[];
  text.split('\n').forEach(line=>{
    if(!line.trim()||line.startsWith('#'))return;
    const parts=line.split('\t');
    if(parts[0]){
      imported.push({
        id:genId(),
        name:parts[0].trim(),
        address:(parts[1]||'').trim(),
        lat:parseFloat(parts[2])||null,
        lng:parseFloat(parts[3])||null
      });
    }
  });
  return imported;
}

// GitHub ì„œë²„ ì„¤ì •
const GITHUB_REPO='KnagByeongju-123/outgoing_car_card';
const GITHUB_FILE='ì¦ê²¨ì°¾ê¸°.txt';

// ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (GitHub raw)
async function loadPlacesFromServer(){
  try{
    showToast('â³ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    const url=`https://raw.githubusercontent.com/${GITHUB_REPO}/main/${encodeURIComponent(GITHUB_FILE)}?t=${Date.now()}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error(`${res.status}`);
    const text=await res.text();
    const imported=parsePlacesTxt(text);
    if(!imported.length){showToast('âŒ ì„œë²„ì— ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
    const mode=confirm(`ì„œë²„ì—ì„œ ${imported.length}ê°œ ì¦ê²¨ì°¾ê¸°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n\n[í™•ì¸] ê¸°ì¡´ì— ì¶”ê°€ (ë³‘í•©)\n[ì·¨ì†Œ] ê¸°ì¡´ ì‚­ì œ í›„ êµì²´`);
    if(mode){
      imported.forEach(p=>{
        const exist=registeredPlaces.findIndex(r=>r.name===p.name);
        if(exist>=0)registeredPlaces[exist]={...registeredPlaces[exist],...p};
        else registeredPlaces.push(p);
      });
    }else{
      registeredPlaces=imported;
    }
    saveAll();render();
    showToast(`ğŸ“¥ ì„œë²„ì—ì„œ ${imported.length}ê°œ ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ`);
  }catch(err){
    if(err.message==='404')showToast('âŒ ì„œë²„ì— ì¦ê²¨ì°¾ê¸° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
    else showToast('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: '+err.message);
  }
}


// ì¦ê²¨ì°¾ê¸° ê°€ì ¸ì˜¤ê¸° (txt)
function importPlaces(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const text=e.target.result;
    let imported=[];
    // JSON í˜•ì‹ ì‹œë„
    try{
      const arr=JSON.parse(text);
      if(Array.isArray(arr))imported=arr;
    }catch{
      // íƒ­ êµ¬ë¶„ txt íŒŒì‹±
      text.split('\n').forEach(line=>{
        if(!line.trim()||line.startsWith('#'))return;
        const parts=line.split('\t');
        if(parts[0]){
          imported.push({
            id:genId(),
            name:parts[0].trim(),
            address:(parts[1]||'').trim(),
            lat:parseFloat(parts[2])||null,
            lng:parseFloat(parts[3])||null
          });
        }
      });
    }
    if(!imported.length){showToast('âŒ ê°€ì ¸ì˜¬ ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤');return}
    const mode=confirm(`${imported.length}ê°œ ì¦ê²¨ì°¾ê¸°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.\n\n[í™•ì¸] ê¸°ì¡´ì— ì¶”ê°€ (ë³‘í•©)\n[ì·¨ì†Œ] ê¸°ì¡´ ì‚­ì œ í›„ êµì²´`);
    if(mode){
      // ë³‘í•©: ì´ë¦„ì´ ê°™ìœ¼ë©´ ë®ì–´ì“°ê¸°
      imported.forEach(p=>{
        if(!p.id)p.id=genId();
        const exist=registeredPlaces.findIndex(r=>r.name===p.name);
        if(exist>=0)registeredPlaces[exist]={...registeredPlaces[exist],...p};
        else registeredPlaces.push(p);
      });
    }else{
      registeredPlaces=imported.map(p=>({...p,id:p.id||genId()}));
    }
    saveAll();render();
    showToast(`ğŸ“¥ ${imported.length}ê°œ ì¦ê²¨ì°¾ê¸° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
    addAudit('CREATE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° ê°€ì ¸ì˜¤ê¸°: ${imported.length}ê±´`);
  };
  reader.readAsText(file);
  event.target.value='';
}

// ê¸°ì¡´ ì¦ê²¨ì°¾ê¸°ì— í˜„ì¬ GPS ì¢Œí‘œ ë“±ë¡
async function gpsRegisterPlace(idx){
  if(gpsLoading)return;gpsLoading=true;
  showToast('ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  try{
    const pos=await getGPS();
    const addr=await reverseGeo(pos.lat,pos.lng);
    registeredPlaces[idx].lat=pos.lat;
    registeredPlaces[idx].lng=pos.lng;
    if(!registeredPlaces[idx].address)registeredPlaces[idx].address=addr.full;
    saveAll();addAudit('UPDATE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° GPS ë“±ë¡: ${registeredPlaces[idx].name} (${pos.lat.toFixed(4)},${pos.lng.toFixed(4)})`);
    showToast(`ğŸ“ ${registeredPlaces[idx].name} ì¢Œí‘œ ë“±ë¡ ì™„ë£Œ`);render();
  }catch(e){showToast('âŒ '+e.message)}
  gpsLoading=false;
}

// í˜„ì¬ ìœ„ì¹˜ë¡œ ìƒˆ ì¦ê²¨ì°¾ê¸° ì¶”ê°€
async function addPlaceWithGPS(){
  const name=document.getElementById('placeInlineName').value.trim();
  if(!name){showToast('âŒ ì¦ê²¨ì°¾ê¸°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  if(gpsLoading)return;gpsLoading=true;
  showToast('ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  try{
    const pos=await getGPS();
    const addr=await reverseGeo(pos.lat,pos.lng);
    const address=document.getElementById('placeInlineAddr').value.trim()||addr.full;
    registeredPlaces.push({id:genId(),name,address,lat:pos.lat,lng:pos.lng});
    saveAll();addAudit('CREATE','place_mgmt','',`ì¦ê²¨ì°¾ê¸° ë“±ë¡(GPS): ${name} (${pos.lat.toFixed(4)},${pos.lng.toFixed(4)})`);
    showToast(`ğŸ¢ğŸ“ ${name} ë“±ë¡ ì™„ë£Œ (ì¢Œí‘œ í¬í•¨)`);render();
  }catch(e){showToast('âŒ '+e.message)}
  gpsLoading=false;
}

// ===== REPORT EMAIL MANAGEMENT =====
function addReportEmail(){
  const email=document.getElementById('reportEmailInput').value.trim();
  const name=document.getElementById('reportNameInput').value.trim();
  if(!email||!/\S+@\S+\.\S+/.test(email)){showToast('âŒ ì˜¬ë°”ë¥¸ ë©”ì¼ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  if(reportEmails.some(e=>e.email===email)){showToast('âŒ ì´ë¯¸ ë“±ë¡ëœ ë©”ì¼ì…ë‹ˆë‹¤');return}
  reportEmails.push({id:genId(),email,name,active:true});
  saveAll();addAudit('CREATE','report_mgmt','',`ë³´ê³ ì²˜ ë“±ë¡: ${email} ${name?'('+name+')':''}`);
  showToast(`ğŸ“§ ${name||email} ë“±ë¡ ì™„ë£Œ`);render();
}
function startEditReportEmail(idx){inlineEditEmailIdx=idx;render()}
function cancelReportEmailEdit(){inlineEditEmailIdx=null;render()}
function saveReportEmailEdit(){
  if(inlineEditEmailIdx===null)return;
  const email=document.getElementById('reportEmailInput').value.trim();
  const name=document.getElementById('reportNameInput').value.trim();
  if(!email||!/\S+@\S+\.\S+/.test(email)){showToast('âŒ ì˜¬ë°”ë¥¸ ë©”ì¼ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  const old=reportEmails[inlineEditEmailIdx];
  reportEmails[inlineEditEmailIdx]={...old,email,name};
  saveAll();addAudit('UPDATE','report_mgmt','',`ë³´ê³ ì²˜ ìˆ˜ì •: ${email}`);
  showToast(`ğŸ“§ ìˆ˜ì • ì™„ë£Œ`);inlineEditEmailIdx=null;render();
}
function deleteReportEmail(idx){
  const e=reportEmails[idx];
  if(!e||!confirm(`ë³´ê³ ì²˜ "${e.name||e.email}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  reportEmails.splice(idx,1);saveAll();
  addAudit('DELETE','report_mgmt','',`ë³´ê³ ì²˜ ì‚­ì œ: ${e.email}`);
  showToast(`ë³´ê³ ì²˜ ì‚­ì œë¨`);if(inlineEditEmailIdx===idx)inlineEditEmailIdx=null;render();
}
function toggleReportEmail(idx){
  reportEmails[idx].active=!(reportEmails[idx].active!==false);
  saveAll();render();
}

// ===== REPORT MAIL SEND =====
function buildReportBody(){
  const m=document.getElementById('filterMonth').value;
  const fc=commuteRecords.filter(r=>r.date?.startsWith(m));
  const fo=outsideRecords.filter(r=>r.date?.startsWith(m));
  const fk=cardRecords.filter(r=>r.date?.startsWith(m));
  const tcd=fc.reduce((s,r)=>s+Number(r.distance||0),0);
  const tod=fo.reduce((s,r)=>s+Number(r.distance||0),0);
  const tca=fk.reduce((s,r)=>s+Number(r.amount||0),0);

  let body=`[${m}] ì°¨ëŸ‰Â·ì¹´ë“œÂ·ì™¸ê·¼ ê´€ë¦¬ëŒ€ì¥ ë³´ê³ ì„œ\n\n`;
  body+=`â”â”â” ìš”ì•½ â”â”â”\n`;
  body+=`ì¶œí‡´ê·¼: ${fc.length}ê±´ / ${tcd} km\n`;
  body+=`ì™¸ê·¼: ${fo.length}ê±´ / ${tod} km\n`;
  body+=`ì¹´ë“œì‚¬ìš©: ${fk.length}ê±´ / ${fmtNum(tca)}ì›\n`;
  body+=`ì´ ì£¼í–‰ê±°ë¦¬: ${tcd+tod} km\n\n`;

  if(fo.length>0){
    body+=`â”â”â” ì™¸ê·¼ ìƒì„¸ â”â”â”\n`;
    fo.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
      body+=`${r.date} | ${r.startPlace||''} â†’ ${r.endPlace||''} | ${r.visitPlace||''}${r.purpose?' ('+r.purpose+')':''} | ${r.distance?r.distance+'km':''}\n`;
    });
    body+=`\n`;
  }

  if(fk.length>0){
    body+=`â”â”â” ì¹´ë“œ ì‚¬ìš© ìƒì„¸ â”â”â”\n`;
    const ì ‘ëŒ€t=fk.filter(r=>isì ‘ëŒ€(r.category)).reduce((s,r)=>s+Number(r.amount||0),0);
    const ë¹„ì ‘ëŒ€t=fk.filter(r=>!isì ‘ëŒ€(r.category)).reduce((s,r)=>s+Number(r.amount||0),0);
    body+=`ì ‘ëŒ€ì„±: ${fmtNum(ì ‘ëŒ€t)}ì› / ë¹„ì ‘ëŒ€ì„±: ${fmtNum(ë¹„ì ‘ëŒ€t)}ì›\n`;
    fk.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
      body+=`${r.date} | ${r.store||''} | ${fmtNum(r.amount)}ì› | ${r.category||''}${r.cardLast4?' | ****'+r.cardLast4:''}\n`;
    });
    body+=`\n`;
  }

  body+=`â”â”â”â”â”â”â”â”â”â”\n`;
  body+=`ë³´ê³ ì„œ ìƒì„±: ${getLocalTime(getNow())}\n`;
  return body;
}

function sendReportEmail(){ /* ë¯¸ì‚¬ìš© */ }

// ë³´ê³ ì„œ TXT íŒŒì¼ ë‹¤ìš´ë¡œë“œ
function downloadReportTxt(){
  const m=document.getElementById('filterMonth').value;
  const txt=buildReportBody();
  const blob=new Blob(['\uFEFF'+txt],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`ì™¸ê·¼ì°¨ëŸ‰ì¹´ë“œê´€ë¦¬ëŒ€ì¥_ë³´ê³ ì„œ_${m}.txt`;a.click();
  URL.revokeObjectURL(url);
  showToast(`ğŸ“„ TXT ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}

// ì™¸ê·¼ ê¸°ë¡ 1ê±´ ê³µìœ 
function shareOutsideRecord(rec){
  let msg=`ğŸ“‹ ì™¸ê·¼ ë³´ê³ \n\n`;
  msg+=`ğŸ“… ${rec.date}\n`;
  if(rec.startPlace)msg+=`ì¶œë°œ: ${rec.startPlace}\n`;
  if(rec.endPlace)msg+=`ë„ì°©: ${rec.endPlace}\n`;
  if(rec.visitPlace)msg+=`ë°©ë¬¸ì²˜: ${rec.visitPlace}\n`;
  if(rec.purpose)msg+=`ëª©ì : ${rec.purpose}\n`;
  if(rec.distance)msg+=`ê±°ë¦¬: ${rec.distance} km\n`;
  if(rec.address)msg+=`ì£¼ì†Œ: ${rec.address}\n`;
  if(rec.memo)msg+=`ë©”ëª¨: ${rec.memo}\n`;
  msg+=`\n${getLocalTime(getNow())} ì „ì†¡`;

  const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  if(isMobile&&navigator.share){
    navigator.share({title:`ì™¸ê·¼ ë³´ê³  - ${rec.date}`,text:msg}).catch(()=>{});
  }else{
    // PC: í´ë¦½ë³´ë“œ ë³µì‚¬
    try{
      navigator.clipboard.writeText(msg);
    }catch{
      const ta=document.createElement('textarea');
      ta.value=msg;document.body.appendChild(ta);
      ta.select();document.execCommand('copy');document.body.removeChild(ta);
    }
    showToast('ğŸ“‹ ì™¸ê·¼ ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”');
  }
}

// ì™¸ê·¼ ì €ì¥ í›„ ê³µìœ  í™•ì¸
function promptShareOutside(rec){
  showToast('ì™¸ê·¼ ê¸°ë¡ ì €ì¥ âœ“');
  setTimeout(()=>{
    if(confirm('ğŸ’¬ ì´ ì™¸ê·¼ ê¸°ë¡ì„ ì¹´í†¡ìœ¼ë¡œ ê³µìœ í• ê¹Œìš”?')){
      shareOutsideRecord(rec);
    }
  },300);
}

function openPlacePicker(target){
  placePickerTarget=target;
  const box=document.getElementById('placePickerBox');
  let h=`<div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ¢ ì¦ê²¨ì°¾ê¸° ì„ íƒ</div>`;
  h+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:12px">${target==='start'?'ì¶œë°œì§€':'ë„ì°©ì§€'}ì— ì ìš©ë©ë‹ˆë‹¤</div>`;
  if(registeredPlaces.length===0){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-dimmer)">ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤<br><span style="color:#a5b4fc;cursor:pointer;text-decoration:underline" onclick="closePlacePicker();openPlaceMgmt()">ì¦ê²¨ì°¾ê¸° ë“±ë¡í•˜ê¸°</span></div>`;
  }else{
    h+=`<div class="place-picker-list">`;
    registeredPlaces.forEach((p,i)=>{
      const hasCoord=!!(p.lat&&p.lng);
      h+=`<div class="place-picker-item" onclick="selectPlace(${i})">
        <div class="pp-name">ğŸ¢ ${p.name} ${hasCoord?'<span style="font-size:10px;color:var(--green)">ğŸ“ ê±°ë¦¬ìë™</span>':'<span style="font-size:10px;color:#6a6a8a">ìˆ˜ë™ì…ë ¥</span>'}</div>
        ${p.address?`<div class="pp-addr">${p.address}</div>`:''}
      </div>`;
    });
    h+=`</div>`;
  }
  h+=`<button class="cancel-btn" onclick="closePlacePicker()">ì·¨ì†Œ</button>`;
  box.innerHTML=h;
  document.getElementById('placePickerModal').classList.remove('hidden');
}
function closePlacePicker(){placePickerTarget=null;document.getElementById('placePickerModal').classList.add('hidden')}
function selectPlace(idx){
  const p=registeredPlaces[idx];if(!p)return;
  const isStart=(placePickerTarget==='start');
  const isEnd=(placePickerTarget==='end'||placePickerTarget==='arrival_end');

  // ì´ë¦„ ì…ë ¥
  if(isStart){
    const el=document.getElementById('f_startPlace');if(el)el.value=p.name;
  }else if(isEnd){
    const el=document.getElementById('f_endPlace');if(el)el.value=p.name;
  }
  // ë°©ë¬¸ì²˜ ìë™ ì…ë ¥ (ë„ì°©ì§€)
  if(isEnd){
    const vp=document.getElementById('f_visitPlace');if(vp&&!vp.value.trim())vp.value=p.name;
  }

  // ì¢Œí‘œê°€ ìˆìœ¼ë©´ GPS hidden í•„ë“œì—ë„ ì£¼ì…
  if(p.lat&&p.lng){
    const prefix=isStart?'start':'end';
    const latEl=document.getElementById(`f_${prefix}Lat`);if(latEl)latEl.value=p.lat;
    const lngEl=document.getElementById(`f_${prefix}Lng`);if(lngEl)lngEl.value=p.lng;
    const addrEl=document.getElementById(`f_${prefix}Addr`);if(addrEl)addrEl.value=p.address||'';
    const accEl=document.getElementById(`f_${prefix}Accuracy`);if(accEl)accEl.value='';
    const timeEl=document.getElementById(`f_${prefix}GpsTime`);if(timeEl)timeEl.value=getNow();

    // ì¹´ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    const card=document.getElementById(isStart?'startLocCard':'endLocCard');
    if(card)card.classList.add('has-gps');
    const btn=document.getElementById(`gpsBtn_${prefix}`);
    if(btn){btn.textContent='ğŸ“ âœ“';btn.classList.add('done')}

    // ë¯¸ë‹ˆë§µ í‘œì‹œ
    showLocCardMap(prefix,p.lat,p.lng,p.address||'',`ì¦ê²¨ì°¾ê¸°: ${p.name}`);

    // ìë™ ê±°ë¦¬ ê³„ì‚° íŠ¸ë¦¬ê±°
    tryCalcOutsideDistance();
    showToast(`ğŸ¢ğŸ“ ${p.name} ì„ íƒë¨ (ì¢Œí‘œ ì ìš©)`);
  }else{
    showToast(`ğŸ¢ ${p.name} ì„ íƒë¨`);
  }
  closePlacePicker();
}

function pickCard(el,last4){
  const hidden=document.getElementById('f_cardSelect');
  const chips=document.querySelectorAll('#cardSelectRow .card-select-chip');
  if(el.classList.contains('selected')){
    el.classList.remove('selected');
    hidden.value='';
  }else{
    chips.forEach(c=>c.classList.remove('selected'));
    el.classList.add('selected');
    hidden.value=last4;
  }
}

// ===== FORM =====
function openForm(id){
  editingId=id||null;
  const sheet=document.getElementById('formSheet');
  const record=editingId?getRecs(activeTab).find(r=>r.id===editingId):null;
  const title=editingId?'ê¸°ë¡ ìˆ˜ì •':activeTab==='commute'?'ğŸ  ì¶œí‡´ê·¼ ê¸°ë¡':activeTab==='outside'?'ğŸš— ì™¸ê·¼ ê¸°ë¡':'ğŸ’³ ì¹´ë“œ ì‚¬ìš©';

  let h=`<div class="form-title">${title}</div>`;

  if(activeTab==='outside'){
    // ë‹¹ì¼ ë§ˆì§€ë§‰ ì™¸ê·¼ ê¸°ë¡ ì°¾ê¸° (ì´ì–´ì„œ ê¸°ë¡ìš©)
    const today=getToday();
    const todayRecs=outsideRecords.filter(r=>r.date===today).sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
    const lastRec=(!editingId && todayRecs.length>0)?todayRecs[0]:null;
    const hasChain=lastRec&&lastRec.lat;

    // hidden fields
    h+=`<input type="hidden" id="f_startLat" value="${record?.startLat||(hasChain?lastRec.lat:'')}">`;
    h+=`<input type="hidden" id="f_startLng" value="${record?.startLng||(hasChain?lastRec.lng:'')}">`;
    h+=`<input type="hidden" id="f_startAddr" value="${record?.startAddr||(hasChain?lastRec.address:'')}">`;
    h+=`<input type="hidden" id="f_startAccuracy" value="${record?.startAccuracy||(hasChain?lastRec.gpsAccuracy:'')}">`;
    h+=`<input type="hidden" id="f_startGpsTime" value="${record?.startGpsTime||(hasChain?lastRec.gpsTime:'')}">`;
    h+=`<input type="hidden" id="f_endLat" value="${record?.lat||''}">`;
    h+=`<input type="hidden" id="f_endLng" value="${record?.lng||''}">`;
    h+=`<input type="hidden" id="f_endAddr" value="${record?.address||''}">`;
    h+=`<input type="hidden" id="f_endAccuracy" value="${record?.gpsAccuracy||''}">`;
    h+=`<input type="hidden" id="f_endGpsTime" value="${record?.gpsTime||''}">`;

    // ì´ì–´ì„œ ê¸°ë¡ ì•ˆë‚´
    if(hasChain&&!editingId){
      h+=`<div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:14px;padding:12px;margin-bottom:10px">
        <div style="font-size:11px;color:#a5b4fc;font-weight:700">ğŸ”— ì´ì „ ë„ì°©ì§€ â†’ ì¶œë°œì§€ ìë™ ì—°ê²°</div>
        <div style="font-size:13px;color:var(--text);font-weight:600;margin-top:2px">${lastRec.endPlace||lastRec.visitPlace||'ì´ì „ ë„ì°©ì§€'}</div>
      </div>`;
    }

    // â”€â”€ ì¶œë°œì§€ ì¹´ë“œ â”€â”€
    const sHasGps=!!(record?.startLat||(hasChain&&lastRec.lat));
    h+=`<div class="loc-card ${sHasGps?'has-gps':''}" id="startLocCard">`;
    h+=`<div class="loc-card-label start">ğŸŸ¢ ì¶œë°œì§€</div>`;
    h+=`<div class="loc-card-row">`;
    const startVal=record?.startPlace||(hasChain?(lastRec.endPlace||lastRec.visitPlace||''):'');
    h+=`<input class="inp" type="text" id="f_startPlace" placeholder="ì¶œë°œì§€ ì…ë ¥" value="${startVal}">`;
    h+=`<button class="loc-card-place" onclick="openPlacePicker('start')">ğŸ¢</button>`;
    h+=`<button class="loc-card-gps ${sHasGps?'done':''}" id="gpsBtn_start" onclick="handleOutsideGPS('start')"${hasChain&&!editingId?' disabled':''}>ğŸ“${sHasGps?' âœ“':''}</button>`;
    h+=`</div>`;
    h+=`<div id="gpsResult_start"></div>`;
    h+=`</div>`;

    // â”€â”€ ë„ì°©ì§€ ì¹´ë“œ â”€â”€
    const eHasGps=!!record?.lat;
    h+=`<div class="loc-card ${eHasGps?'has-gps':''}" id="endLocCard" style="border-color:${eHasGps?'rgba(99,102,241,0.3)':'rgba(255,255,255,0.08)'}">`;
    h+=`<div class="loc-card-label end">ğŸ”µ ë„ì°©ì§€</div>`;
    h+=`<div class="loc-card-row">`;
    h+=`<input class="inp" type="text" id="f_endPlace" placeholder="ë„ì°©ì§€ ì…ë ¥" value="${record?.endPlace||''}">`;
    h+=`<button class="loc-card-place" onclick="openPlacePicker('end')">ğŸ¢</button>`;
    h+=`<button class="loc-card-gps end-style ${eHasGps?'done':''}" id="gpsBtn_end" onclick="handleOutsideGPS('end')">ğŸ“${eHasGps?' âœ“':''}</button>`;
    h+=`</div>`;
    h+=`<div id="gpsResult_end"></div>`;
    h+=`</div>`;

    // ê±°ë¦¬ ê³„ì‚° ê²°ê³¼
    h+=`<div id="routeResult" class="gps-result hidden" style="margin-bottom:10px;border-color:rgba(129,201,149,0.3);background:rgba(129,201,149,0.08)"></div>`;

    h+=`<div class="gps-hint">${hasChain&&!editingId?'ğŸ’¡ ë„ì°©ì§€ GPSë§Œ ë“±ë¡í•˜ë©´ ê±°ë¦¬ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤':'ğŸ’¡ ì¶œë°œì§€Â·ë„ì°©ì§€ì— GPS ë“±ë¡ ë˜ëŠ” ì§ì ‘ ì…ë ¥ ê°€ëŠ¥'}</div><hr class="divider">`;

    // ë‚˜ë¨¸ì§€ í•„ë“œ
    const fields=[{k:'date',l:'ë‚ ì§œ',t:'date'},{k:'visitPlace',l:'ë°©ë¬¸ì²˜ (ì„ íƒ)',p:'ì˜ˆ: ì¥ì†Œëª…'},{k:'purpose',l:'ëª©ì  (ì„ íƒ)',p:'ì˜ˆ: ë¯¸íŒ…, ë‚©í’ˆ'},{k:'distance',l:'ì£¼í–‰ê±°ë¦¬ km',t:'number',p:'GPS ì‹œ ìë™ê³„ì‚°'},{k:'memo',l:'ë©”ëª¨ (ì„ íƒ)',p:'ì°¸ê³  ì‚¬í•­'}];
    fields.forEach(f=>{
      let val=record?(record[f.k]||''):(f.k==='date'?getToday():'');
      h+=`<div class="ig"><label class="lb">${f.l}</label>`;
      h+=`<input class="inp" type="${f.t||'text'}" id="f_${f.k}" placeholder="${f.p||''}" value="${val}">`;
      h+=`</div>`;
    });

    // ì¶œë°œë§Œ ê¸°ë¡ / ì „ì²´ ì €ì¥ ë²„íŠ¼
    if(!editingId&&!record){
      h+=`<button class="submit-btn" onclick="submitForm()">ì €ì¥</button>`;
      h+=`<button class="submit-btn" onclick="submitOutsideStartOnly()" style="background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5));margin-top:6px">ğŸš— ì¶œë°œë§Œ ê¸°ë¡ (ë„ì°© ì‹œ ì´ì–´ì„œ ë“±ë¡)</button>`;
    }else{
      h+=`<button class="submit-btn" onclick="submitForm()">${editingId?'ìˆ˜ì • ì™„ë£Œ':'ì €ì¥'}</button>`;
    }
    h+=`<button class="cancel-btn" onclick="cancelForm()">ì·¨ì†Œ</button>`;
    sheet.innerHTML=h;
    document.getElementById('formOverlay').classList.remove('hidden');

    // GPS ë¯¸ë‹ˆë§µ í‘œì‹œ
    if(!editingId&&hasChain){
      showLocCardMap('start',lastRec.lat,lastRec.lng,lastRec.address||'','ì´ì „ ë„ì°©ì§€ì—ì„œ ìë™');
    }
    if(record?.startLat){
      showLocCardMap('start',record.startLat,record.startLng,record.startAddr||'');
    }
    if(record?.lat){
      showLocCardMap('end',record.lat,record.lng,record.address||'');
    }
    return;
  }

  if(activeTab==='commute'){
    // === ì¶œí‡´ê·¼: ì™¸ê·¼ê³¼ ë™ì¼í•œ ì¶œë°œì§€/ë„ì°©ì§€ ì¹´ë“œí˜• ===
    const today=getToday();
    const todayRecs=commuteRecords.filter(r=>r.date===today).sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
    const lastRec=(!editingId && todayRecs.length>0)?todayRecs[0]:null;
    const hasChain=lastRec&&lastRec.lat;

    h+=`<input type="hidden" id="f_startLat" value="${record?.startLat||(hasChain?lastRec.lat:'')}">`;
    h+=`<input type="hidden" id="f_startLng" value="${record?.startLng||(hasChain?lastRec.lng:'')}">`;
    h+=`<input type="hidden" id="f_startAddr" value="${record?.startAddr||(hasChain?lastRec.address:'')}">`;
    h+=`<input type="hidden" id="f_startAccuracy" value="${record?.startAccuracy||(hasChain?lastRec.gpsAccuracy:'')}">`;
    h+=`<input type="hidden" id="f_startGpsTime" value="${record?.startGpsTime||(hasChain?lastRec.gpsTime:'')}">`;
    h+=`<input type="hidden" id="f_endLat" value="${record?.lat||''}">`;
    h+=`<input type="hidden" id="f_endLng" value="${record?.lng||''}">`;
    h+=`<input type="hidden" id="f_endAddr" value="${record?.address||''}">`;
    h+=`<input type="hidden" id="f_endAccuracy" value="${record?.gpsAccuracy||''}">`;
    h+=`<input type="hidden" id="f_endGpsTime" value="${record?.gpsTime||''}">`;

    if(hasChain&&!editingId){
      h+=`<div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:14px;padding:12px;margin-bottom:10px">
        <div style="font-size:11px;color:#a5b4fc;font-weight:700">ğŸ”— ì´ì „ ë„ì°©ì§€ â†’ ì¶œë°œì§€ ìë™ ì—°ê²°</div>
        <div style="font-size:13px;color:var(--text);font-weight:600;margin-top:2px">${lastRec.endPlace||'ì´ì „ ë„ì°©ì§€'}</div>
      </div>`;
    }

    const sHasGps=!!(record?.startLat||(hasChain&&lastRec.lat));
    h+=`<div class="loc-card ${sHasGps?'has-gps':''}" id="startLocCard">`;
    h+=`<div class="loc-card-label start">ğŸŸ¢ ì¶œë°œì§€</div>`;
    h+=`<div class="loc-card-row">`;
    const startVal=record?.startPlace||(hasChain?(lastRec.endPlace||''):'');
    h+=`<input class="inp" type="text" id="f_startPlace" placeholder="ì¶œë°œì§€ ì…ë ¥" value="${startVal}">`;
    h+=`<button class="loc-card-place" onclick="openPlacePicker('start')">ğŸ¢</button>`;
    h+=`<button class="loc-card-gps ${sHasGps?'done':''}" id="gpsBtn_start" onclick="handleOutsideGPS('start')"${hasChain&&!editingId?' disabled':''}>ğŸ“${sHasGps?' âœ“':''}</button>`;
    h+=`</div><div id="gpsResult_start"></div></div>`;

    const eHasGps=!!record?.lat;
    h+=`<div class="loc-card ${eHasGps?'has-gps':''}" id="endLocCard" style="border-color:${eHasGps?'rgba(99,102,241,0.3)':'rgba(255,255,255,0.08)'}">`;
    h+=`<div class="loc-card-label end">ğŸ”µ ë„ì°©ì§€</div>`;
    h+=`<div class="loc-card-row">`;
    h+=`<input class="inp" type="text" id="f_endPlace" placeholder="ë„ì°©ì§€ ì…ë ¥" value="${record?.endPlace||''}">`;
    h+=`<button class="loc-card-place" onclick="openPlacePicker('end')">ğŸ¢</button>`;
    h+=`<button class="loc-card-gps end-style ${eHasGps?'done':''}" id="gpsBtn_end" onclick="handleOutsideGPS('end')">ğŸ“${eHasGps?' âœ“':''}</button>`;
    h+=`</div><div id="gpsResult_end"></div></div>`;

    h+=`<div id="routeResult" class="gps-result hidden" style="margin-bottom:10px;border-color:rgba(129,201,149,0.3);background:rgba(129,201,149,0.08)"></div>`;
    h+=`<div class="gps-hint">${hasChain&&!editingId?'ğŸ’¡ ë„ì°©ì§€ GPSë§Œ ë“±ë¡í•˜ë©´ ê±°ë¦¬ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤':'ğŸ’¡ ì¶œë°œì§€Â·ë„ì°©ì§€ì— GPS ë“±ë¡ ë˜ëŠ” ì§ì ‘ ì…ë ¥ ê°€ëŠ¥'}</div><hr class="divider">`;

    const fields=[{k:'date',l:'ë‚ ì§œ',t:'date'},{k:'distance',l:'ì£¼í–‰ê±°ë¦¬ km',t:'number',p:'GPS ì‹œ ìë™ê³„ì‚°'},{k:'memo',l:'ë©”ëª¨ (ì„ íƒ)',p:'ì°¸ê³  ì‚¬í•­'}];
    fields.forEach(f=>{
      let val=record?(record[f.k]||''):(f.k==='date'?getToday():'');
      h+=`<div class="ig"><label class="lb">${f.l}</label>`;
      h+=`<input class="inp" type="${f.t||'text'}" id="f_${f.k}" placeholder="${f.p||''}" value="${val}">`;
      h+=`</div>`;
    });

    if(!editingId&&!record){
      h+=`<button class="submit-btn" onclick="submitForm()">ì €ì¥</button>`;
      h+=`<button class="submit-btn" onclick="submitCommuteStartOnly()" style="background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5));margin-top:6px">ğŸš— ì¶œë°œë§Œ ê¸°ë¡ (ë„ì°© ì‹œ ì´ì–´ì„œ ë“±ë¡)</button>`;
    }else{
      h+=`<button class="submit-btn" onclick="submitForm()">${editingId?'ìˆ˜ì • ì™„ë£Œ':'ì €ì¥'}</button>`;
    }
    h+=`<button class="cancel-btn" onclick="cancelForm()">ì·¨ì†Œ</button>`;
    sheet.innerHTML=h;
    document.getElementById('formOverlay').classList.remove('hidden');

    if(!editingId&&hasChain){
      showLocCardMap('start',lastRec.lat,lastRec.lng,lastRec.address||'','ì´ì „ ë„ì°©ì§€ì—ì„œ ìë™');
    }
    if(record?.startLat){
      showLocCardMap('start',record.startLat,record.startLng,record.startAddr||'');
    }
    if(record?.lat){
      showLocCardMap('end',record.lat,record.lng,record.address||'');
    }
    return;
  }

  // === ì¹´ë“œ: ê¸°ì¡´ ë‹¨ì¼ GPS ë°©ì‹ ===
  h+=`<button class="gps-btn" id="gpsBtn" onclick="handleGPSInForm()">ğŸ“ í˜„ì¬ ìœ„ì¹˜ ë“±ë¡</button>`;
  h+=`<div id="gpsResult" class="gps-result hidden"></div>`;
  h+=`<input type="hidden" id="f_lat" value="${record?.lat||''}">`;
  h+=`<input type="hidden" id="f_lng" value="${record?.lng||''}">`;
  h+=`<input type="hidden" id="f_address" value="${record?.address||''}">`;
  h+=`<input type="hidden" id="f_gpsAccuracy" value="${record?.gpsAccuracy||''}">`;
  h+=`<input type="hidden" id="f_gpsTime" value="${record?.gpsTime||''}">`;
  h+=`<div class="gps-hint">ğŸ’¡ ìœ„ì¹˜ë§Œ ë“±ë¡í•˜ê³  ì €ì¥ ê°€ëŠ¥!</div><hr class="divider">`;

  const fields=[{k:'date',l:'ë‚ ì§œ',t:'date'},{k:'cardSelect',l:'ì‚¬ìš© ì¹´ë“œ',t:'cardpicker'},{k:'store',l:'ì‚¬ìš©ì²˜ (ìœ„ì¹˜ë“±ë¡ ì‹œ ìë™)',p:'ì˜ˆ: ì¹´í˜, ì£¼ìœ ì†Œ'},{k:'amount',l:'ê¸ˆì•¡ (ì›)',t:'number',p:'0'},{k:'category',l:'ë¶„ë¥˜',t:'select'},{k:'memo',l:'ë©”ëª¨ (ì„ íƒ)',p:'ì°¸ê³  ì‚¬í•­'}];

  fields.forEach(f=>{
    const val=record?(record[f.k]||''):(f.k==='date'?getToday():'');
    h+=`<div class="ig"><label class="lb">${f.l}</label>`;
    if(f.t==='select'){
      h+=`<select class="sel" id="f_${f.k}">`;
      h+=`<optgroup label="â”€â”€ ì ‘ëŒ€ì„± â”€â”€">${CATS_ì ‘ëŒ€.map(c=>`<option value="${c}" ${val===c?'selected':''}>${c}</option>`).join('')}</optgroup>`;
      h+=`<optgroup label="â”€â”€ ë¹„ì ‘ëŒ€ì„± â”€â”€">${CATS_ë¹„ì ‘ëŒ€.map(c=>`<option value="${c}" ${val===c?'selected':''}>${c}</option>`).join('')}</optgroup>`;
      h+=`</select>`;
    }
    else if(f.t==='cardpicker'){
      const selCard=record?.cardLast4||'';
      h+=`<div id="cardPickerContainer">`;
      if(registeredCards.length===0){
        h+=`<div style="font-size:13px;color:var(--text-dimmer);padding:12px;background:rgba(255,255,255,0.03);border-radius:12px;text-align:center">ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
        h+=`<div class="card-add-row" style="margin-top:8px">
          <input class="inp" id="inlineCard4" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="ë’·4ìë¦¬" style="flex:0.6">
          <input class="inp" id="inlineCardLabel" type="text" placeholder="ë³„ì¹­ (ì„ íƒ)" style="flex:1">
          <button class="card-add-btn" onclick="addCardInline()">ì¶”ê°€</button>
        </div>`;
        h+=`<input type="hidden" id="f_cardSelect" value="">`;
      }else{
        h+=`<div class="card-select-row" id="cardSelectRow">`;
        registeredCards.forEach(c=>{
          const isSel=selCard===c.last4;
          h+=`<button type="button" class="card-select-chip ${isSel?'selected':''}" data-card="${c.last4}" onclick="pickCard(this,'${c.last4}')">
            ğŸ’³ **** ${c.last4}${c.label?' Â· '+c.label:''}
          </button>`;
        });
        h+=`</div>`;
        h+=`<div class="card-add-row" style="margin-top:8px">
          <input class="inp" id="inlineCard4" type="text" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="ë’·4ìë¦¬ ì¶”ê°€" style="flex:0.6">
          <input class="inp" id="inlineCardLabel" type="text" placeholder="ë³„ì¹­" style="flex:1">
          <button class="card-add-btn" style="padding:10px 14px;font-size:13px" onclick="addCardInline()">+</button>
        </div>`;
        h+=`<input type="hidden" id="f_cardSelect" value="${selCard}">`;
      }
      h+=`</div>`;
    }
    else h+=`<input class="inp" type="${f.t||'text'}" id="f_${f.k}" placeholder="${f.p||''}" value="${val}">`;
    h+=`</div>`;
  });

  h+=`<button class="submit-btn" onclick="submitForm()">${editingId?'ìˆ˜ì • ì™„ë£Œ':'ì €ì¥'}</button>`;
  h+=`<button class="cancel-btn" onclick="cancelForm()">ì·¨ì†Œ</button>`;
  sheet.innerHTML=h;
  document.getElementById('formOverlay').classList.remove('hidden');

  if(record?.lat){
    const gpsRes=document.getElementById('gpsResult');gpsRes.classList.remove('hidden');
    gpsRes.innerHTML=`<div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:4px">ğŸ“ ìœ„ì¹˜ ë“±ë¡ë¨</div>
      <div style="font-size:14px;color:var(--text);font-weight:600">${record.endPlace||record.store||''}</div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:2px">${record.address||''}</div>
      <div style="font-size:10px;color:#6a6a8a;margin-top:2px">ì¸¡ì •: ${getLocalTime(record.gpsTime)}</div>`;
  }
}
function cancelForm(){editingId=null;document.getElementById('formOverlay').classList.add('hidden')}

function submitForm(){
  const g=id=>document.getElementById('f_'+id)?.value?.trim()||'';
  const now=getNow();
  const date=g('date')||getToday();

  if(activeTab==='outside'){
    // ì™¸ê·¼: ì¶œë°œì§€/ë„ì°©ì§€ ê°œë³„ GPS
    const endLat=parseFloat(g('endLat'))||null;
    const endLng=parseFloat(g('endLng'))||null;
    const rec={
      lat:endLat,lng:endLng,address:g('endAddr'),gpsAccuracy:parseFloat(g('endAccuracy'))||null,gpsTime:g('endGpsTime')||null,
      startLat:parseFloat(g('startLat'))||null,startLng:parseFloat(g('startLng'))||null,startAddr:g('startAddr'),startAccuracy:parseFloat(g('startAccuracy'))||null,startGpsTime:g('startGpsTime')||null,
      date,visitPlace:g('visitPlace'),purpose:g('purpose'),startPlace:g('startPlace'),endPlace:g('endPlace'),distance:g('distance'),memo:g('memo')
    };
    if(editingId){
      const old=outsideRecords.find(r=>r.id===editingId);
      rec.createdAt=old?.createdAt||now;rec.lastModified=now;rec.editCount=(old?.editCount||0)+1;
      outsideRecords=outsideRecords.map(r=>r.id===editingId?{...rec,id:editingId}:r);
      addAudit('UPDATE','outside',editingId,`ë‚ ì§œ:${date}${rec.distance?' / '+rec.distance+'km':''}`);showToast('ìˆ˜ì • ì™„ë£Œ');
    }else{
      rec.createdAt=now;rec.lastModified=now;rec.editCount=0;
      const id=genId();outsideRecords.unshift({...rec,id});
      addAudit('CREATE','outside',id,`ë‚ ì§œ:${date} / ${rec.visitPlace||rec.endPlace||'ìœ„ì¹˜ë“±ë¡'}${rec.distance?' / '+rec.distance+'km':''}`);
    }
    saveAll();cancelForm();render();
    if(!editingId)promptShareOutside(rec);
    return;
  }

  if(activeTab==='commute'){
    const endLat=parseFloat(g('endLat'))||null;
    const endLng=parseFloat(g('endLng'))||null;
    const rec={
      lat:endLat,lng:endLng,address:g('endAddr'),gpsAccuracy:parseFloat(g('endAccuracy'))||null,gpsTime:g('endGpsTime')||null,
      startLat:parseFloat(g('startLat'))||null,startLng:parseFloat(g('startLng'))||null,startAddr:g('startAddr'),startAccuracy:parseFloat(g('startAccuracy'))||null,startGpsTime:g('startGpsTime')||null,
      date,startPlace:g('startPlace'),endPlace:g('endPlace'),distance:g('distance'),memo:g('memo')
    };
    if(editingId){
      const old=commuteRecords.find(r=>r.id===editingId);
      rec.createdAt=old?.createdAt||now;rec.lastModified=now;rec.editCount=(old?.editCount||0)+1;
      commuteRecords=commuteRecords.map(r=>r.id===editingId?{...rec,id:editingId}:r);
      addAudit('UPDATE','commute',editingId,`ë‚ ì§œ:${date}${rec.distance?' / '+rec.distance+'km':''}`);showToast('ìˆ˜ì • ì™„ë£Œ');
    }else{
      rec.createdAt=now;rec.lastModified=now;rec.editCount=0;
      const id=genId();commuteRecords.unshift({...rec,id});
      addAudit('CREATE','commute',id,`ë‚ ì§œ:${date} / ${rec.startPlace||''}â†’${rec.endPlace||''}${rec.distance?' / '+rec.distance+'km':''}`);showToast('ì¶œí‡´ê·¼ ê¸°ë¡ ì €ì¥');
    }
    saveAll();cancelForm();render();
    return;
  }

  const lat=parseFloat(g('lat'))||null;
  const lng=parseFloat(g('lng'))||null;
  const base={lat,lng,address:g('address'),gpsAccuracy:parseFloat(g('gpsAccuracy'))||null,gpsTime:g('gpsTime')||null};

  // ì¹´ë“œë§Œ ë‚¨ìŒ
  {
    const cardLast4=g('cardSelect');
    const rec={...base,date,store:g('store'),amount:g('amount'),category:g('category'),memo:g('memo'),cardLast4};
    if(editingId){
      const old=cardRecords.find(r=>r.id===editingId);
      rec.createdAt=old?.createdAt||now;rec.lastModified=now;rec.editCount=(old?.editCount||0)+1;
      cardRecords=cardRecords.map(r=>r.id===editingId?{...rec,id:editingId}:r);
      addAudit('UPDATE','card',editingId,`ë‚ ì§œ:${date} / ${rec.amount}ì›${cardLast4?' / ì¹´ë“œ:****'+cardLast4:''}`);showToast('ìˆ˜ì • ì™„ë£Œ');
    }else{
      rec.createdAt=now;rec.lastModified=now;rec.editCount=0;
      const id=genId();cardRecords.unshift({...rec,id});
      addAudit('CREATE','card',id,`ë‚ ì§œ:${date} / ${rec.store||''} ${rec.amount?fmtNum(rec.amount)+'ì›':''}${cardLast4?' / ì¹´ë“œ:****'+cardLast4:''}`);showToast('ì¹´ë“œ ë‚´ì—­ ì €ì¥');
    }
  }
  saveAll();cancelForm();render();
}

// ===== EXPORT =====
function exportCSV(){
  const m=document.getElementById('filterMonth').value;
  const fc=commuteRecords.filter(r=>r.date?.startsWith(m));
  const fo=outsideRecords.filter(r=>r.date?.startsWith(m));
  const fk=cardRecords.filter(r=>r.date?.startsWith(m));
  let csv='\uFEFF';

  csv+='=== ì¶œí‡´ê·¼ ìš´í–‰ ===\n';
  csv+='ë‚ ì§œ,ì¶œë°œì§€,ë„ì°©ì§€,ê±°ë¦¬(km),ìœ„ì¹˜(ì£¼ì†Œ),ìœ„ë„,ê²½ë„,GPSì •í™•ë„(m),GPSì¸¡ì •ì‹œê°,ìµœì´ˆë“±ë¡ì‹œê°,ìµœì¢…ìˆ˜ì •ì‹œê°,ìˆ˜ì •íšŸìˆ˜,í•´ì‹œ,ë©”ëª¨\n';
  fc.forEach(r=>{csv+=`${r.date},${r.startPlace||''},${r.endPlace||''},${r.distance||''},${r.address||''},${r.lat||''},${r.lng||''},${r.gpsAccuracy?Math.round(r.gpsAccuracy):''},${getLocalTime(r.gpsTime)},${getLocalTime(r.createdAt)},${getLocalTime(r.lastModified)},${r.editCount||0},${recordHash(r)},${r.memo||''}\n`});

  csv+='\n=== ì™¸ê·¼ ìš´í–‰ ===\n';
  csv+='ë‚ ì§œ,ë°©ë¬¸ì²˜,ëª©ì ,ì¶œë°œì§€,ì¶œë°œì§€ìœ„ë„,ì¶œë°œì§€ê²½ë„,ì¶œë°œì§€GPSì •í™•ë„(m),ë„ì°©ì§€,ë„ì°©ì§€ìœ„ë„,ë„ì°©ì§€ê²½ë„,ë„ì°©ì§€GPSì •í™•ë„(m),ë„ë¡œê±°ë¦¬(km),ë„ì°©ì§€ì£¼ì†Œ,ìµœì´ˆë“±ë¡ì‹œê°,ìµœì¢…ìˆ˜ì •ì‹œê°,ìˆ˜ì •íšŸìˆ˜,í•´ì‹œ,ë©”ëª¨\n';
  fo.forEach(r=>{csv+=`${r.date},${r.visitPlace||''},${r.purpose||''},${r.startPlace||''},${r.startLat||''},${r.startLng||''},${r.startAccuracy?Math.round(r.startAccuracy):''},${r.endPlace||''},${r.lat||''},${r.lng||''},${r.gpsAccuracy?Math.round(r.gpsAccuracy):''},${r.distance||''},${r.address||''},${getLocalTime(r.createdAt)},${getLocalTime(r.lastModified)},${r.editCount||0},${recordHash(r)},${r.memo||''}\n`});

  csv+='\n=== ì¹´ë“œ ì‚¬ìš© ===\n';
  csv+='ë‚ ì§œ,ì‚¬ìš©ì¹´ë“œ,ì‚¬ìš©ì²˜,ê¸ˆì•¡,ë¶„ë¥˜,ì ‘ëŒ€êµ¬ë¶„,ìœ„ì¹˜(ì£¼ì†Œ),ìœ„ë„,ê²½ë„,GPSì •í™•ë„(m),GPSì¸¡ì •ì‹œê°,ìµœì´ˆë“±ë¡ì‹œê°,ìµœì¢…ìˆ˜ì •ì‹œê°,ìˆ˜ì •íšŸìˆ˜,í•´ì‹œ,ë©”ëª¨\n';
  fk.forEach(r=>{csv+=`${r.date},${r.cardLast4?'****'+r.cardLast4:''},${r.store||''},${r.amount||''},${r.category||''},${isì ‘ëŒ€(r.category)?'ì ‘ëŒ€ì„±':'ë¹„ì ‘ëŒ€ì„±'},${r.address||''},${r.lat||''},${r.lng||''},${r.gpsAccuracy?Math.round(r.gpsAccuracy):''},${getLocalTime(r.gpsTime)},${getLocalTime(r.createdAt)},${getLocalTime(r.lastModified)},${r.editCount||0},${recordHash(r)},${r.memo||''}\n`});

  // ê°ì‚¬ë¡œê·¸ë„ í¬í•¨
  const monthAudit=auditLog.filter(a=>a.timestamp?.startsWith(m.replace('-','')||''));
  csv+='\n=== ê°ì‚¬ ë¡œê·¸ ===\n';
  csv+='ì‹œê°,êµ¬ë¶„,ìœ í˜•,ëŒ€ìƒID,ìƒì„¸,ê¸°ê¸°ì •ë³´\n';
  auditLog.forEach(a=>{csv+=`${getLocalTime(a.timestamp)},${a.action},${a.type},${a.recordId},${a.detail},${a.deviceInfo}\n`});

  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download=`ì™¸ê·¼ì°¨ëŸ‰ì¹´ë“œê´€ë¦¬ëŒ€ì¥_${m}_ê°ì‚¬í¬í•¨.csv`;a.click();
  URL.revokeObjectURL(url);showToast('ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ (ê°ì‚¬ë¡œê·¸ í¬í•¨)');
}

// ì „ì²´ ë°ì´í„° ë°±ì—… (JSON)
function exportAllData(){
  const data={
    version:1,
    exportDate:new Date().toISOString(),
    commuteRecords,
    outsideRecords,
    cardRecords,
    registeredPlaces,
    reportEmails,
    auditLog
  };
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`ì™¸ê·¼ì°¨ëŸ‰ì¹´ë“œê´€ë¦¬ëŒ€ì¥_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;a.click();
  URL.revokeObjectURL(url);
  const cnt=commuteRecords.length+outsideRecords.length+cardRecords.length;
  showToast(`ğŸ“¤ ì „ì²´ ë°±ì—… ì™„ë£Œ (${cnt}ê±´)`);
}

// ì „ì²´ ë°ì´í„° ë³µì› (JSON)
function importAllData(event){
  const file=event.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      const cnt=(data.commuteRecords?.length||0)+(data.outsideRecords?.length||0)+(data.cardRecords?.length||0);
      const msg=`ë°±ì—… ë°ì´í„° í™•ì¸:\n`
        +`- ì¶œí‡´ê·¼: ${data.commuteRecords?.length||0}ê±´\n`
        +`- ì™¸ê·¼: ${data.outsideRecords?.length||0}ê±´\n`
        +`- ì¹´ë“œ: ${data.cardRecords?.length||0}ê±´\n`
        +`- ì¦ê²¨ì°¾ê¸°: ${data.registeredPlaces?.length||0}ê±´\n\n`
        +`[í™•ì¸] ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ (ë³‘í•©)\n[ì·¨ì†Œ] ê¸°ì¡´ ì‚­ì œ í›„ êµì²´`;
      const merge=confirm(msg);
      if(merge){
        // ë³‘í•©: id ì¤‘ë³µ ì œê±°
        const mergeArr=(existing,incoming)=>{
          const ids=new Set(existing.map(r=>r.id));
          return [...existing,...(incoming||[]).filter(r=>!ids.has(r.id))];
        };
        commuteRecords=mergeArr(commuteRecords,data.commuteRecords);
        outsideRecords=mergeArr(outsideRecords,data.outsideRecords);
        cardRecords=mergeArr(cardRecords,data.cardRecords);
        if(data.registeredPlaces){
          data.registeredPlaces.forEach(p=>{
            const exist=registeredPlaces.findIndex(r=>r.name===p.name);
            if(exist>=0)registeredPlaces[exist]={...registeredPlaces[exist],...p};
            else registeredPlaces.push(p);
          });
        }
      }else{
        commuteRecords=data.commuteRecords||[];
        outsideRecords=data.outsideRecords||[];
        cardRecords=data.cardRecords||[];
        registeredPlaces=data.registeredPlaces||[];
        if(data.reportEmails)reportEmails=data.reportEmails;
        if(data.auditLog)auditLog=data.auditLog;
      }
      saveAll();render();
      addAudit('CREATE','backup','',`ë°ì´í„° ë³µì›: ${cnt}ê±´ (${merge?'ë³‘í•©':'êµì²´'})`);
      showToast(`ğŸ“¥ ë°ì´í„° ë³µì› ì™„ë£Œ (${cnt}ê±´)`);
    }catch(err){
      showToast('âŒ íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜: JSON ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤');
    }
  };
  reader.readAsText(file);
  event.target.value='';
}

// ===== RENDER =====
function render(){
  const area=document.getElementById('contentArea');
  const month=document.getElementById('filterMonth').value;
  const filter=arr=>arr.filter(r=>r.date?.startsWith(month)).sort((a,b)=>b.date.localeCompare(a.date));

  // â”€â”€ ì¦ê²¨ì°¾ê¸° íƒ­ â”€â”€
  if(activeTab==='places'){
    let h=`<div style="font-size:17px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ¢ ì¦ê²¨ì°¾ê¸° ê´€ë¦¬</div>`;
    h+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:16px">ì¢Œí‘œê°€ ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸°ëŠ” ì„ íƒ ì‹œ ê±°ë¦¬ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</div>`;

    if(registeredPlaces.length>0){
      registeredPlaces.forEach((p,i)=>{
        const hasCoord=!!(p.lat&&p.lng);
        h+=`<div class="place-chip" style="border-color:${hasCoord?'rgba(52,168,83,0.3)':'rgba(255,255,255,0.06)'}">
          <div class="place-chip-info">
            <div class="place-chip-name">ğŸ¢ ${p.name} ${hasCoord?'<span style="font-size:10px;color:var(--green)">ğŸ“</span>':''}</div>
            ${p.address?`<div class="place-chip-addr">${p.address}</div>`:''}
            ${hasCoord?`<div style="font-size:9px;color:#6a6a8a;margin-top:2px">ì¢Œí‘œ: ${Number(p.lat).toFixed(4)}, ${Number(p.lng).toFixed(4)}</div>`:'<div style="font-size:9px;color:#ffb347;margin-top:2px">âš ï¸ ì¢Œí‘œ ë¯¸ë“±ë¡ (GPS ë“±ë¡ ê¶Œì¥)</div>'}
          </div>
          <div class="place-chip-actions">
            ${i>0?`<button onclick="movePlaceUp(${i})" title="ìœ„ë¡œ" style="color:#93c5fd">â–²</button>`:'<button style="visibility:hidden">â–²</button>'}
            ${i<registeredPlaces.length-1?`<button onclick="movePlaceDown(${i})" title="ì•„ë˜ë¡œ" style="color:#93c5fd">â–¼</button>`:'<button style="visibility:hidden">â–¼</button>'}
            <button onclick="gpsRegisterPlace(${i})" title="í˜„ì¬ ìœ„ì¹˜ ë“±ë¡" style="color:var(--green)">ğŸ“</button>
            <button onclick="startEditPlaceInline(${i})">âœï¸</button>
            <button onclick="deletePlace(${i})" style="color:#f87171">ğŸ—‘</button>
          </div>
        </div>`;
      });
    }else{
      h+=`<div class="empty" style="padding:40px 20px"><div style="font-size:40px;margin-bottom:12px">ğŸ¢</div><div style="font-size:15px;font-weight:600">ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size:13px;margin-top:6px">ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”</div></div>`;
    }

    // ì¶”ê°€/ìˆ˜ì • í¼
    const ep=inlineEditPlaceIdx!==null?registeredPlaces[inlineEditPlaceIdx]:null;
    h+=`<div style="margin-top:16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px">`;
    h+=`<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px">${ep?'âœï¸ ì¦ê²¨ì°¾ê¸° ìˆ˜ì •':'â• ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}</div>`;
    h+=`<div class="ig"><input class="inp" id="placeInlineName" type="text" placeholder="ì¦ê²¨ì°¾ê¸°ëª… *" value="${ep?ep.name:''}"></div>`;
    h+=`<div class="ig"><input class="inp" id="placeInlineAddr" type="text" placeholder="ì£¼ì†Œ (ì„ íƒ)" value="${ep?ep.address:''}"></div>`;

    // ì¢Œí‘œ ì…ë ¥ ì˜ì—­
    h+=`<div style="background:rgba(99,102,241,0.05);border:1px solid rgba(99,102,241,0.15);border-radius:12px;padding:12px;margin-bottom:10px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#a5b4fc;margin-bottom:8px">ğŸ“ ì¢Œí‘œ ë“±ë¡ (3ê°€ì§€ ë°©ë²•)</div>`;

    // ë°©ë²•1: ì£¼ì†Œ ê²€ìƒ‰
    h+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">â‘  ë„ë¡œëª… ê²€ìƒ‰</div>`;
    h+=`<div style="display:flex;gap:6px;margin-bottom:8px">`;
    h+=`<input class="inp" id="placeSearchQuery" type="text" placeholder="ì˜ˆ: ì°½ì›ì‹œ ì„±ì‚°êµ¬ ì •ë™ë¡œ" style="flex:1;font-size:12px">`;
    h+=`<button class="loc-card-gps" style="padding:8px 12px;font-size:12px" onclick="searchPlaceAddr()" id="addrSearchBtn">ğŸ”</button>`;
    h+=`</div>`;
    h+=`<div id="addrSearchResult"></div>`;

    // ë°©ë²•2: ì¢Œí‘œ ì§ì ‘ ì…ë ¥
    h+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;margin-top:8px">â‘¡ ì¢Œí‘œ ë˜ëŠ” êµ¬ê¸€ë§µ URL ë¶™ì—¬ë„£ê¸°</div>`;
    h+=`<div class="ig" style="margin-bottom:6px"><input class="inp" id="placeCoordPaste" type="text" placeholder="ì¢Œí‘œ ë˜ëŠ” êµ¬ê¸€ë§µ URL ë¶™ì—¬ë„£ê¸°" style="font-size:12px" oninput="parseCoordPaste(this.value)"></div>`;
    h+=`<div style="display:flex;gap:6px;margin-bottom:6px">`;
    h+=`<input class="inp" id="placeInlineLat" type="number" step="any" placeholder="ìœ„ë„" value="${ep?.lat||''}" style="flex:1;font-size:12px">`;
    h+=`<input class="inp" id="placeInlineLng" type="number" step="any" placeholder="ê²½ë„" value="${ep?.lng||''}" style="flex:1;font-size:12px">`;
    h+=`</div>`;
    h+=`<a href="https://www.google.com/maps" target="_blank" style="display:inline-block;font-size:11px;color:#4285f4;text-decoration:none;padding:5px 10px;background:rgba(66,133,244,0.1);border-radius:8px;margin-bottom:4px">ğŸ—ºï¸ êµ¬ê¸€ë§µì—ì„œ ê²€ìƒ‰</a>`;
    h+=`<div style="font-size:9px;color:#6a6a8a;margin-top:2px">ğŸ’¡ ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ë¹¨ê°„í•€ ê¸¸ê²Œ ëˆ„ë¥´ê¸° â†’ ìœ„ë„/ê²½ë„ ì¢Œí‘œ(ì†Œìˆ˜ì 5ìë¦¬) ì…ë ¥</div>`;
    h+=`<div style="font-size:9px;color:#6a6a8a">ğŸ’¡ PC: êµ¬ê¸€ë§µ ìœ„ì¹˜ ìš°í´ë¦­ â†’ ì¢Œí‘œ í´ë¦­(ìë™ë³µì‚¬) â†’ ë¶™ì—¬ë„£ê¸°</div>`;

    // ë°©ë²•3: GPS
    h+=`<div style="font-size:11px;color:var(--text-dim);margin-top:8px">â‘¢ í˜„ì¥ì—ì„œ GPS ë“±ë¡ â†’ ì•„ë˜ "í˜„ì¬ ìœ„ì¹˜ë¡œ ì¶”ê°€" ë²„íŠ¼</div>`;
    h+=`</div>`;

    // ì¢Œí‘œ ë¯¸ë¦¬ë³´ê¸°
    if(ep&&ep.lat){
      h+=`<div style="font-size:10px;color:var(--green);margin-bottom:4px">ğŸ“ ì¢Œí‘œ ë“±ë¡ë¨: ${Number(ep.lat).toFixed(4)}, ${Number(ep.lng).toFixed(4)}</div>`;
      h+=`<div class="mini-map" style="margin-bottom:8px"><iframe loading="lazy" src="https://www.openstreetmap.org/export/embed.html?bbox=${ep.lng-0.004},${ep.lat-0.003},${Number(ep.lng)+0.004},${Number(ep.lat)+0.003}&layer=mapnik&marker=${ep.lat},${ep.lng}"></iframe></div>`;
    }
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap">`;
    if(ep){
      h+=`<button class="submit-btn" style="flex:1;margin-top:0" onclick="saveInlinePlaceEdit()">ìˆ˜ì • ì™„ë£Œ</button>`;
      h+=`<button class="cancel-btn" style="flex:1;margin-top:0" onclick="cancelInlinePlaceEdit()">ì·¨ì†Œ</button>`;
    }else{
      h+=`<button class="submit-btn" style="flex:1;margin-top:0" onclick="addPlaceInline()">ì¶”ê°€</button>`;
      h+=`<button class="submit-btn" style="flex:1;margin-top:0;background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5))" onclick="addPlaceWithGPS()">ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¡œ ì¶”ê°€</button>`;
    }
    h+=`</div></div>`;

    // ì¦ê²¨ì°¾ê¸° íŒŒì¼ ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
    if(registeredPlaces.length>0||true){
    h+=`<div style="margin-top:16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:14px">`;
    h+=`<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">ğŸ“ ì¦ê²¨ì°¾ê¸° íŒŒì¼ ê´€ë¦¬</div>`;
    h+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:10px">ë‹¤ë¥¸ ê¸°ê¸°ì™€ ì¦ê²¨ì°¾ê¸° ëª©ë¡ì„ ê³µìœ í•˜ê±°ë‚˜ ë°±ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>`;
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">`;
    h+=`<button class="submit-btn" style="flex:1;margin-top:0;font-size:12px" onclick="exportPlaces()">ğŸ“¤ íŒŒì¼ ë‚´ë³´ë‚´ê¸°</button>`;
    h+=`<label class="submit-btn" style="flex:1;margin-top:0;font-size:12px;text-align:center;cursor:pointer;background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5))">ğŸ“¥ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°<input type="file" accept=".txt,.json" style="display:none" onchange="importPlaces(event)"></label>`;
    h+=`</div>`;
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap">`;
    h+=`<button class="submit-btn" style="flex:1;margin-top:0;font-size:12px;background:linear-gradient(135deg,rgba(99,102,241,0.5),rgba(79,70,229,0.4))" onclick="loadPlacesFromServer()">ğŸŒ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>`;
    h+=`</div>`;
    h+=`<div style="font-size:9px;color:#6a6a8a;margin-top:6px;text-align:center">GitHubì— ë“±ë¡ëœ ì¦ê²¨ì°¾ê¸°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>`;
    h+=`</div>`;
    }

    area.innerHTML=h;
    return;
  }

  // â”€â”€ ë³´ê³ ì²˜ íƒ­ â”€â”€
  if(activeTab==='report'){
    let h=`<div style="font-size:17px;font-weight:800;color:var(--text);margin-bottom:4px">ğŸ“§ ë³´ê³ ì²˜ ê´€ë¦¬</div>`;
    h+=`<div style="font-size:12px;color:var(--text-dim);margin-bottom:16px">ê¸°ë¡ ì €ì¥ ì‹œ í™œì„±í™”ëœ ë³´ê³ ì²˜ë¡œ ë©”ì¼ì´ ì „ì†¡ë©ë‹ˆë‹¤</div>`;

    if(reportEmails.length>0){
      reportEmails.forEach((e,i)=>{
        const isOn=e.active!==false;
        h+=`<div class="place-chip" style="border-color:${isOn?'rgba(52,168,83,0.3)':'rgba(255,255,255,0.06)'}">
          <div style="cursor:pointer;flex-shrink:0;font-size:22px;margin-right:6px" onclick="toggleReportEmail(${i})">${isOn?'âœ…':'â¬œ'}</div>
          <div class="place-chip-info">
            <div class="place-chip-name" style="font-size:13px">${e.name||e.email}</div>
            <div class="place-chip-addr">${e.email}${e.name?' Â· '+e.name:''}</div>
          </div>
          <div class="place-chip-actions">
            <button onclick="startEditReportEmail(${i})">âœï¸</button>
            <button onclick="deleteReportEmail(${i})" style="color:#f87171">ğŸ—‘</button>
          </div>
        </div>`;
      });
    }else{
      h+=`<div class="empty" style="padding:40px 20px"><div style="font-size:40px;margin-bottom:12px">ğŸ“§</div><div style="font-size:15px;font-weight:600">ë“±ë¡ëœ ë³´ê³ ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size:13px;margin-top:6px">ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”</div></div>`;
    }

    const ee=inlineEditEmailIdx!==null?reportEmails[inlineEditEmailIdx]:null;
    h+=`<div style="margin-top:16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px">`;
    h+=`<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px">${ee?'âœï¸ ë³´ê³ ì²˜ ìˆ˜ì •':'â• ë³´ê³ ì²˜ ì¶”ê°€'}</div>`;
    h+=`<div class="ig"><input class="inp" id="reportEmailInput" type="email" placeholder="ë©”ì¼ì£¼ì†Œ *" value="${ee?ee.email:''}"></div>`;
    h+=`<div class="ig"><input class="inp" id="reportNameInput" type="text" placeholder="ì´ë¦„/ì§ì±… (ì„ íƒ)" value="${ee?ee.name:''}"></div>`;
    h+=`<div style="display:flex;gap:8px">`;
    if(ee){
      h+=`<button class="submit-btn" style="flex:1;margin-top:0" onclick="saveReportEmailEdit()">ìˆ˜ì • ì™„ë£Œ</button>`;
      h+=`<button class="cancel-btn" style="flex:1;margin-top:0" onclick="cancelReportEmailEdit()">ì·¨ì†Œ</button>`;
    }else{
      h+=`<button class="submit-btn" style="margin-top:0" onclick="addReportEmail()">ì¶”ê°€</button>`;
    }
    h+=`</div></div>`;

    // ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
    h+=`<div style="margin-top:20px;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);border-radius:16px;padding:16px">`;
    h+=`<div style="font-size:14px;font-weight:700;color:#a5b4fc;margin-bottom:6px">ğŸ“¨ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</div>`;
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap">`;
    h+=`<button class="submit-btn" style="flex:1;margin-top:0;font-size:12px;background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5))" onclick="exportCSV()">ğŸ“Š CSV ë‹¤ìš´ë¡œë“œ</button>`;
    h+=`<button class="submit-btn" style="flex:1;margin-top:0;font-size:12px;background:linear-gradient(135deg,rgba(59,130,246,0.6),rgba(37,99,235,0.5))" onclick="downloadReportTxt()">ğŸ“„ TXT ë‹¤ìš´ë¡œë“œ</button>`;
    h+=`</div>`;
    h+=`<div style="font-size:10px;color:#6a6a8a;margin-top:6px;text-align:center">CSV: ì „ì²´ ë°ì´í„°+ê°ì‚¬ë¡œê·¸ (ì—‘ì…€) / TXT: ìƒì„¸ ë³´ê³ ì„œ</div>`;
    h+=`</div>`;

    // ë°ì´í„° ë°±ì—…/ë³µì›
    h+=`<div style="margin-top:16px;background:rgba(255,165,0,0.06);border:1px solid rgba(255,165,0,0.15);border-radius:16px;padding:16px">`;
    h+=`<div style="font-size:14px;font-weight:700;color:#ffb347;margin-bottom:6px">ğŸ’¾ ë°ì´í„° ë°±ì—… / ë³µì›</div>`;
    h+=`<div style="font-size:11px;color:var(--text-dim);margin-bottom:10px">ëª¨ë“  ê¸°ë¡(ì¶œí‡´ê·¼Â·ì™¸ê·¼Â·ì¹´ë“œÂ·ì¦ê²¨ì°¾ê¸°)ì„ ë‹¤ë¥¸ ê¸°ê¸°ë¡œ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>`;
    h+=`<div style="display:flex;gap:8px;flex-wrap:wrap">`;
    h+=`<button class="submit-btn" style="flex:1;margin-top:0;font-size:12px;background:linear-gradient(135deg,rgba(255,165,0,0.5),rgba(255,140,0,0.4))" onclick="exportAllData()">ğŸ“¤ ì „ì²´ ë°±ì—…</button>`;
    h+=`<label class="submit-btn" style="flex:1;margin-top:0;font-size:12px;text-align:center;cursor:pointer;background:linear-gradient(135deg,rgba(52,168,83,0.6),rgba(34,139,34,0.5))">ğŸ“¥ ë³µì›í•˜ê¸°<input type="file" accept=".json" style="display:none" onchange="importAllData(event)"></label>`;
    h+=`</div>`;
    h+=`<div style="font-size:10px;color:#6a6a8a;margin-top:6px;text-align:center">ë°±ì—… â†’ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ â†’ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë³µì›í•˜ê¸°</div>`;
    h+=`</div>`;

    area.innerHTML=h;
    return;
  }

  if(activeTab==='summary'){
    const fc=filter(commuteRecords),fo=filter(outsideRecords),fk=filter(cardRecords);
    const tcd=fc.reduce((s,r)=>s+Number(r.distance||0),0);
    const tod=fo.reduce((s,r)=>s+Number(r.distance||0),0);
    const tca=fk.reduce((s,r)=>s+Number(r.amount||0),0);
    // ì ‘ëŒ€ì„±/ë¹„ì ‘ëŒ€ì„± ì†Œê³„
    const ì ‘ëŒ€total=fk.filter(r=>isì ‘ëŒ€(r.category)).reduce((s,r)=>s+Number(r.amount||0),0);
    const ë¹„ì ‘ëŒ€total=fk.filter(r=>!isì ‘ëŒ€(r.category)).reduce((s,r)=>s+Number(r.amount||0),0);
    const ì ‘ëŒ€cnt=fk.filter(r=>isì ‘ëŒ€(r.category)).length;
    const ë¹„ì ‘ëŒ€cnt=fk.filter(r=>!isì ‘ëŒ€(r.category)).length;

    let catH='';
    // ì ‘ëŒ€ì„±/ë¹„ì ‘ëŒ€ì„± ì†Œê³„ ì¹´ë“œ
    if(fk.length>0){
      catH+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">`;
      catH+=`<div style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:16px;padding:16px">
        <div style="font-size:12px;color:#f87171;font-weight:700">ğŸ”´ ì ‘ëŒ€ì„±</div>
        <div style="font-size:22px;font-weight:800;color:#fca5a5;margin-top:4px">${fmtNum(ì ‘ëŒ€total)}ì›</div>
        <div style="font-size:11px;color:#8888a8;margin-top:2px">${ì ‘ëŒ€cnt}ê±´</div>
      </div>`;
      catH+=`<div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:16px;padding:16px">
        <div style="font-size:12px;color:#818cf8;font-weight:700">ğŸ”µ ë¹„ì ‘ëŒ€ì„±</div>
        <div style="font-size:22px;font-weight:800;color:#a5b4fc;margin-top:4px">${fmtNum(ë¹„ì ‘ëŒ€total)}ì›</div>
        <div style="font-size:11px;color:#8888a8;margin-top:2px">${ë¹„ì ‘ëŒ€cnt}ê±´</div>
      </div>`;
      catH+=`</div>`;
    }

    // ì ‘ëŒ€ì„± ì„¸ë¶€
    const ì ‘ëŒ€cats=CATS_ì ‘ëŒ€.map(c=>({c,t:fk.filter(r=>r.category===c).reduce((s,r)=>s+Number(r.amount||0),0),n:fk.filter(r=>r.category===c).length})).filter(x=>x.t>0);
    if(ì ‘ëŒ€cats.length){
      catH+=`<div style="font-size:13px;font-weight:700;color:#fca5a5;margin-bottom:10px">ğŸ”´ ì ‘ëŒ€ì„± ì„¸ë¶€</div>`;
      ì ‘ëŒ€cats.forEach(x=>{
        catH+=`<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:#fca5a5;font-weight:600">${x.c}</span><span style="color:#8888a8">${fmtNum(x.t)}ì› (${x.n}ê±´)</span></div><div class="cat-bar"><div class="cat-fill" style="width:${ì ‘ëŒ€total?(x.t/ì ‘ëŒ€total*100):0}%;background:linear-gradient(90deg,#ef4444,#f87171)"></div></div></div>`;
      });
    }

    // ë¹„ì ‘ëŒ€ì„± ì„¸ë¶€
    const ë¹„ì ‘ëŒ€cats=CATS_ë¹„ì ‘ëŒ€.map(c=>({c,t:fk.filter(r=>r.category===c).reduce((s,r)=>s+Number(r.amount||0),0),n:fk.filter(r=>r.category===c).length})).filter(x=>x.t>0);
    if(ë¹„ì ‘ëŒ€cats.length){
      catH+=`<div style="font-size:13px;font-weight:700;color:#a5b4fc;margin-bottom:10px;margin-top:16px">ğŸ”µ ë¹„ì ‘ëŒ€ì„± ì„¸ë¶€</div>`;
      ë¹„ì ‘ëŒ€cats.forEach(x=>{
        catH+=`<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:#a5b4fc;font-weight:600">${x.c}</span><span style="color:#8888a8">${fmtNum(x.t)}ì› (${x.n}ê±´)</span></div><div class="cat-bar"><div class="cat-fill" style="width:${ë¹„ì ‘ëŒ€total?(x.t/ë¹„ì ‘ëŒ€total*100):0}%"></div></div></div>`;
      });
    }

    area.innerHTML=`
      <div class="sum-grid">
        <div class="sum-card"><div class="sum-val">${tcd}</div><div class="sum-lbl">ì¶œí‡´ê·¼ (km)</div><div class="sum-lbl" style="font-size:11px">${fc.length}ê±´</div></div>
        <div class="sum-card"><div class="sum-val">${tod}</div><div class="sum-lbl">ì™¸ê·¼ (km)</div><div class="sum-lbl" style="font-size:11px">${fo.length}ê±´</div></div>
      </div>
      <div class="sum-card" style="margin-bottom:16px"><div class="sum-val">${fmtNum(tca)}ì›</div><div class="sum-lbl">ì¹´ë“œ ì‚¬ìš© ì´ì•¡ Â· ${fk.length}ê±´</div></div>
      <div class="sum-card" style="background:rgba(255,255,255,0.03)"><div style="font-size:14px;font-weight:700;margin-bottom:4px;color:#a5b4fc">ì´ ì£¼í–‰ê±°ë¦¬</div><div class="sum-val" style="font-size:32px">${tcd+tod} km</div></div>
      ${catH?`<div style="margin-top:20px"><div style="font-size:15px;font-weight:700;margin-bottom:14px;color:#c4b5fd">ì¹´ë“œ ì‚¬ìš© ë¶„ë¥˜ë³„ (ì ‘ëŒ€/ë¹„ì ‘ëŒ€)</div>${catH}</div>`:''}
      <button class="export-btn" onclick="exportCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ (ê°ì‚¬ë¡œê·¸ í¬í•¨)</button>
      <button class="export-btn" style="border-color:rgba(255,165,0,0.3);color:#ffb347" onclick="showHistory()">ğŸ“‹ ê°ì‚¬ ë¡œê·¸ ë³´ê¸°</button>
      <div class="audit-info">
        <b>ğŸ“Œ ì„¸ë¬´ì¦ë¹™ ì•ˆë‚´</b><br>
        Â· ëª¨ë“  ê¸°ë¡ì— <b>ìµœì´ˆë“±ë¡ì‹œê°Â·ìˆ˜ì •ì‹œê°Â·ìˆ˜ì •íšŸìˆ˜</b>ê°€ ìë™ ì €ì¥ë©ë‹ˆë‹¤<br>
        Â· GPS ìœ„ì¹˜ ë“±ë¡ ì‹œ <b>ì¢Œí‘œÂ·ì •í™•ë„Â·ì¸¡ì •ì‹œê°</b>ì´ í•¨ê»˜ ê¸°ë¡ë©ë‹ˆë‹¤<br>
        Â· ì‚­ì œ í¬í•¨ ëª¨ë“  ë³€ê²½ ì´ë ¥ì´ <b>ê°ì‚¬ ë¡œê·¸</b>ì— ë‚¨ìŠµë‹ˆë‹¤<br>
        Â· CSV ë‚´ë³´ë‚´ê¸° ì‹œ <b>ë¬´ê²°ì„± í•´ì‹œÂ·ê°ì‚¬ë¡œê·¸</b>ê°€ í•¨ê»˜ í¬í•¨ë©ë‹ˆë‹¤<br>
        Â· ì •ê¸°ì ìœ¼ë¡œ CSVë¥¼ ë‚´ë³´ë‚´ì–´ ë³„ë„ ë³´ê´€í•˜ì‹œê¸°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤
      </div>
    `;
    return;
  }

  const recs=filter(getRecs(activeTab));
  if(!recs.length){area.innerHTML=`<div class="empty"><div style="font-size:40px;margin-bottom:12px">ğŸ“</div><div style="font-size:15px;font-weight:600">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size:13px;margin-top:6px">+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”</div></div>`;return}

  let h='';

  // ì¶œí‡´ê·¼/ì™¸ê·¼ íƒ­: ë‚ ì§œë³„ ê·¸ë£¹í•‘ + ë‹¹ì¼ ì´í•©
  if(activeTab==='outside'||activeTab==='commute'){
    const dateGroups={};
    recs.forEach(r=>{
      if(!dateGroups[r.date])dateGroups[r.date]=[];
      dateGroups[r.date].push(r);
    });
    const dates=Object.keys(dateGroups).sort((a,b)=>b.localeCompare(a));
    dates.forEach(date=>{
      const dayRecs=dateGroups[date].sort((a,b)=>(a.createdAt||'').localeCompare(b.createdAt||''));
      const dayTotal=dayRecs.reduce((s,r)=>s+Number(r.distance||0),0);
      const segCount=dayRecs.filter(r=>Number(r.distance||0)>0).length;
      if(dayRecs.length>1||dayTotal>0){
        h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 4px 6px">
          <div style="font-size:13px;font-weight:700;color:var(--primary-light)">${date}</div>
          <div style="font-size:12px;color:var(--green);font-weight:700">${dayTotal>0?'ğŸ›£ï¸ ë‹¹ì¼ ì´ '+dayTotal.toFixed(1)+' km'+(segCount>1?' ('+segCount+'êµ¬ê°„)':''):''}</div>
        </div>`;
      }
      dayRecs.forEach((r,idx)=>{
        h+=`<div class="record-card"${r.pendingArrival?' style="border-color:rgba(255,165,0,0.3);background:linear-gradient(135deg,rgba(255,165,0,0.05),rgba(255,255,255,0.02))"':''}>`;
        h+=`<div class="record-actions">`;
        if(r.pendingArrival)h+=`<button class="act-btn" style="background:rgba(99,102,241,0.15);color:#a5b4fc" onclick="openArrivalForm('${r.id}')">ğŸ ë„ì°©</button>`;
        h+=`<button class="act-btn" onclick="openForm('${r.id}')">âœï¸</button><button class="act-btn" onclick="askDelete('${r.id}')">ğŸ—‘</button></div>`;
        if(dayRecs.length>1)h+=`<div style="font-size:10px;color:var(--text-dimmer);margin-bottom:4px">êµ¬ê°„ ${idx+1}</div>`;
        if(r.pendingArrival)h+=`<div class="pending-badge" style="margin-bottom:6px">â³ ì´ë™ ì¤‘ - ë„ì°© ëŒ€ê¸°</div>`;
        // ë©”ì¸ í‘œì‹œ
        if(activeTab==='outside'){
          h+=`<div class="record-main">${r.visitPlace||r.endPlace||r.startPlace||'ê¸°ë¡ ë¯¸ì…ë ¥'} ${r.purpose?`(${r.purpose})`:''}</div>`;
        }else{
          h+=`<div class="record-main">${r.endPlace||r.startPlace||'ê¸°ë¡ ë¯¸ì…ë ¥'}</div>`;
        }
        if(r.startPlace||r.endPlace)h+=`<div class="record-sub">${r.startPlace?r.startPlace:''}${r.startPlace&&r.endPlace?' â†’ ':''}${r.endPlace||''}</div>`;
        if(r.pendingArrival&&r.startPlace&&!r.endPlace)h+=`<div class="record-sub" style="color:#ffb347">${r.startPlace} ì¶œë°œ</div>`;
        // GPS ì§€ë„ ë²„íŠ¼
        if(r.startLat&&r.lat)h+=`<button class="loc-badge" onclick="showMap('${activeTab}','${r.id}')" style="font-size:10px">ğŸ“ ì¶œë°œÂ·ë„ì°© GPS</button>`;
        else if(r.lat)h+=`<button class="loc-badge" onclick="showMap('${activeTab}','${r.id}')">ğŸ“ ë„ì°©ì§€ <span style="font-size:10px;opacity:.7">ì§€ë„</span></button>`;
        else if(r.startLat)h+=`<button class="loc-badge" onclick="showMap('${activeTab}','${r.id}')">ğŸ“ ì¶œë°œì§€ <span style="font-size:10px;opacity:.7">ì§€ë„</span></button>`;
        if(r.distance)h+=`<span class="badge" style="margin-left:6px">ğŸ›£ï¸ ${r.distance} km</span>`;
        if(r.memo)h+=`<div class="record-sub">${r.memo}</div>`;
        h+=`<div class="timestamp">ğŸ• ë“±ë¡: ${getLocalTime(r.createdAt)}`;
        if(r.editCount>0)h+=` <span class="edited">Â· ìˆ˜ì •${r.editCount}íšŒ (${getLocalTime(r.lastModified)})</span>`;
        h+=`</div>`;
        h+=`<div class="hash-tag">ID:${r.id} / H:${recordHash(r)}</div>`;
        h+=`</div>`;
      });
    });
    area.innerHTML=h;
    return;
  }

  // ì¹´ë“œ íƒ­
  recs.forEach(r=>{
    h+=`<div class="record-card">`;
    h+=`<div class="record-actions"><button class="act-btn" onclick="openForm('${r.id}')">âœï¸</button><button class="act-btn" onclick="askDelete('${r.id}')">ğŸ—‘</button></div>`;
    h+=`<div class="record-date">${r.date}</div>`;

    h+=`<div class="record-main">${r.store||'ì‚¬ìš©ì²˜ ë¯¸ì…ë ¥'}<span class="amount-text">${fmtNum(r.amount)}${r.amount?'ì›':''}</span></div>`;
    if(r.cardLast4)h+=`<div style="font-size:11px;color:#8888a8;margin-top:2px">ğŸ’³ **** ${r.cardLast4}</div>`;
    h+=`<div class="badge" style="${isì ‘ëŒ€(r.category)?'background:rgba(239,68,68,0.15);color:#fca5a5':''}">${r.category||''}</div>`;
    if(r.lat)h+=` <button class="loc-badge" onclick="showMap('card','${r.id}')">ğŸ“ ì§€ë„</button>`;
    else h+=` <button class="loc-badge-orange" onclick="quickCheckin('card','${r.id}')">ğŸ“ ìœ„ì¹˜ ë“±ë¡</button>`;
    if(r.memo)h+=`<div class="record-sub">${r.memo}</div>`;

    // íƒ€ì„ìŠ¤íƒ¬í”„ & ë¬´ê²°ì„±
    h+=`<div class="timestamp">ğŸ• ë“±ë¡: ${getLocalTime(r.createdAt)}`;
    if(r.editCount>0)h+=` <span class="edited">Â· ìˆ˜ì •${r.editCount}íšŒ (${getLocalTime(r.lastModified)})</span>`;
    h+=`</div>`;
    h+=`<div class="hash-tag">ID:${r.id} / H:${recordHash(r)}</div>`;
    h+=`</div>`;
  });
  area.innerHTML=h;
}

// ===== INIT =====
document.getElementById('filterMonth').value=getCurMonth();
document.getElementById('filterMonth').addEventListener('change',render);
loadAll();
updateCardMgmtBtn();
render();
</script>
</body>
</html>
